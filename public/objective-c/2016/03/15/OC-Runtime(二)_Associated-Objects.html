<!DOCTYPE html>
<html lang = "en">
<head>
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/posts/favico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/posts/favico/favico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/posts/favico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/posts/favico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/posts/favico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/posts/favico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/posts/favico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/posts/favico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/posts/favico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/posts/favico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/posts/favico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/images/posts/favico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/posts/favico/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/posts/favico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/images/posts/favico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">   

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/font-awesome/css/font-awesome.min.css">
    <link href="/assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
<!--     <script type="text/javascript" src="http://api.youziku.com/webfont/FastJS/yzk_976E121ED7CC0870"></script> -->

    <title>SHUNMIAN</title>
</head>


<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 sidebar hidden-xs sidebar">
                
<!--sidebar.html-->
        <header class="sidebar_header " role="banner">
            <a href="http://www.shunmian.me/index.html">
                <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df?s=150" class="img-circle img-responsive center-block sidebar_logo sidebar_img" />
            </a>


            <h3 class="title text-center">
                <a href="http://www.shunmian.me/index.html">SHUNMIAN</a>
            </h3>

        </header>


        <hr class="hr_short"/>
        <div id = "bio" class="text-center sidebar_bio">
            

                <p>嗨，欢迎来到我的博客。<br/>
                我是Shunmian，一名iOS开发者。<br/>
                <hr class = "hr_short_low">
                正在学习Algorithm，Functional Programming，Machine Learning，Data Mining 和 Cloud Computation。 

                </p>

            
        </div>


        <hr class="hr_middle"/>
        <div id = "contact-list" class="text-center">
            <ul class="list-unstyled list-inline">
                <li>
                    
                    <a class="btn btn_info_outline" href="mailto:shunmian@gmail.com"><i class="fa fa-envelope fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-github fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-twitter fa-lg"></i></a>
                    
                </li>

                <li>
                    <a class="btn btn_info_outline" href="http://www.shunmian.me/feed.xml"><i class="fa fa-rss fa-lg"></i></a>
                </li>
        </div>


        <hr class="hr_short"/>
        <div id = "contact-list" class="text-center">
            <ul class="unstyled-list list-inline">
                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/index.html"><i class="fa fa-home fa-md"></i> 主页</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/tags.html"><i class="fa fa-tags fa-md"></i> 标签</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/categories.html"><i class="fa fa-list fa-md"></i> 分类</a>
                </li>
            </ul>
        </div>
        <div class="padding_bottom_500"></div>




<!--sidebar.html end-->

            </div>

            <div class="col-sm-9 col-sm-offset-3">
                

<div class="page-header col-sm-10 col-sm-offset-1">
    <h1 class="article_mainTitle">OC Runtime(二)： Associated Objects </h1>
    <span class="post_date">
        2016-03-15 •
    </span>
    <span class="post_category">
        Objective-C
    </span>
</div>

<article class="article">
    <div class="col-sm-10 col-sm-offset-1">
        <div class="article_mainBody">
            <p class="article_content_title">目录</p>

<ul id="markdown-toc">
  <li><a href="#ivar-vs-property" id="markdown-toc-ivar-vs-property">1. iVar VS Property</a></li>
  <li><a href="#associated-objects" id="markdown-toc-associated-objects">2 Associated Objects增加属性</a>    <ul>
      <li><a href="#section" id="markdown-toc-section">2.1在匿名类中增加属性</a></li>
      <li><a href="#runtime-api" id="markdown-toc-runtime-api">2.2 在Runtime API中动态增加属性</a></li>
      <li><a href="#runtime-api-1" id="markdown-toc-runtime-api-1">2.3. Runtime API介绍</a></li>
    </ul>
  </li>
  <li><a href="#section-1" id="markdown-toc-section-1">3 总结</a></li>
</ul>

<hr class="hr-short-left" />

<h2 id="ivar-vs-property">1. iVar VS Property</h2>

<p>Obective C 的类，本质是<code class="highlighter-rouge">struct objc_class</code>结构体，它的定义如下：</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">objc_class</span> <span class="o">*</span><span class="n">Class</span><span class="p">;</span> 
<span class="k">struct</span> <span class="n">objc_class</span> <span class="p">{</span> 
   <span class="n">Class</span> <span class="n">isa</span><span class="p">;</span> 
   <span class="n">Class</span> <span class="n">super_class</span><span class="p">;</span> 
   <span class="kt">long</span> <span class="n">version</span> <span class="p">;</span> 
   <span class="kt">long</span> <span class="n">info</span> <span class="p">;</span> 
   <span class="kt">long</span> <span class="n">instance_size</span> <span class="p">;</span> 
   <span class="k">struct</span> <span class="n">objc_ivar_list</span> <span class="o">*</span><span class="n">ivars</span> <span class="p">;</span> 
   <span class="k">struct</span> <span class="n">objc_method_list</span> <span class="o">**</span><span class="n">methodLists</span> <span class="p">;</span> 
   <span class="k">struct</span> <span class="n">objc_cache</span> <span class="o">*</span><span class="n">cache</span> <span class="p">;</span> 
   <span class="k">struct</span> <span class="n">objc_protocol_list</span> <span class="o">*</span><span class="n">protocols</span> <span class="p">;</span> 
<span class="p">}</span> <span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><code class="highlighter-rouge">objc_ivar_list *ivars</code>是一个存储了<code class="highlighter-rouge">objc_ivar</code>的list。在Objective C中我们知道<code class="highlighter-rouge"><span class="k">@property</span></code>是声明了setter和getter的语法糖,
 <code class="highlighter-rouge">@synthesis</code> 是实现了setter和getter的语法糖(Xcode 4.4及之后的版本可以省略)。在类中声明的每一个property都被一个<code class="highlighter-rouge">iVar</code> backup（property 名字前加_）。<code class="highlighter-rouge">objc_method_list **methodLists</code>是一个指针的指针。通过修改该指针指向的指针的值，就可以实现动态地为某一个类增加成员方法。这也是Category实现的原理。同时也说明了为什么Category只可为对象增加成员方法，却不能增加成员变量。</p>

<p>关于<code class="highlighter-rouge">objc_ivar_list</code>, 我们看下面代码。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="n">Person</span><span class="p">.</span><span class="n">h</span>

<span class="k">@interface</span> <span class="nc">Person</span> <span class="p">:</span> <span class="nc">NSObject</span><span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">ivarName</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">propertyName</span><span class="p">;</span>
<span class="k">@end</span>


<span class="n">Person</span><span class="p">.</span><span class="n">m</span>

<span class="k">@implementation</span> <span class="nc">Person</span>
<span class="k">@synthesize</span> <span class="n">propertyName</span> <span class="o">=</span> <span class="n">_propertyName</span><span class="p">;</span><span class="c1">//可省略
</span><span class="k">-</span><span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="n">init</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">self</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">init</span><span class="p">]){</span>
        <span class="n">ivarName</span> <span class="o">=</span> <span class="s">@"ivar"</span><span class="p">;</span>
        <span class="n">_propertyName</span> <span class="o">=</span> <span class="s">@"property"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>我们创建了一个<code class="highlighter-rouge">Person</code>类，其有一个iVar为NSString *类型的<code class="highlighter-rouge">ivarName</code>，一个property为NSString *类型的<code class="highlighter-rouge">propertyName</code>。我们打印Person类的<code class="highlighter-rouge">objc_ivar_list *ivars</code>:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    
<span class="n">id</span> <span class="n">personClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">person</span> <span class="nf">class</span><span class="p">];</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ivarNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Person objc_ivar_list: "</span><span class="p">);</span>
<span class="n">Ivar</span> <span class="o">*</span><span class="n">ivarArray</span> <span class="o">=</span> <span class="n">class_copyIvarList</span><span class="p">(</span><span class="n">personClass</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivarNumber</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ivarNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Ivar</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">ivarArray</span><span class="p">[</span><span class="nf">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s, "</span><span class="p">,</span><span class="n">ivar_getName</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//输出为:
//Person objc_ivar_list: ivarName, _propertyName, 
</span><span class="o">//</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>可见在一个类的本身定义中, iVar和Property都被加在<code class="highlighter-rouge">objc_ivar_list</code>中。</p>

<h2 id="associated-objects">2 Associated Objects增加属性</h2>

<h3 id="section">2.1在匿名类中增加属性</h3>

<p>我们知道<code class="highlighter-rouge">Category</code>可以用来扩展方法，但扩展不了类的iVar。Associated Objects 的出现就是为了解决这一问题。它让<code class="highlighter-rouge">Category</code>增加属性，就好像类本身定义中的属性一样可以用dot notation进行存取。但是它不加入类的<code class="highlighter-rouge">objc_ivar_list</code>中，而是存储在一个哈希表中。我们来看下面代码，给<code class="highlighter-rouge">Person+AssociatedObjects</code>增加一个属性类型为NSString *<code class="highlighter-rouge">的associatedObjctName</code>:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></td><td class="code"><pre><span class="n">Person</span><span class="o">+</span><span class="n">AssociatedObjects</span><span class="p">.</span><span class="n">h</span>

<span class="cp">#import "Person.h"
#import &lt;objc/runtime.h&gt;
</span>
<span class="k">@interface</span> <span class="nc">Person</span> <span class="p">(</span><span class="nl">AssociatedObjects</span><span class="p">)</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">associatedObjcName</span><span class="p">;</span>
<span class="k">@end</span>


<span class="n">Person</span><span class="o">+</span><span class="n">AssociatedObjects</span><span class="p">.</span><span class="n">m</span>

<span class="k">@implementation</span> <span class="nc">Person</span> <span class="p">(</span><span class="nl">AssociatedObjects</span><span class="p">)</span>

<span class="k">-</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">associatedObjcName</span><span class="p">{</span>
    <span class="k">return</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">associatedObjcName</span><span class="p">));</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setAssociatedObjcName</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">associatedObjcName</span><span class="p">{</span>
    <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="n">associatedObjcName</span><span class="p">),</span> <span class="n">associatedObjcName</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_COPY_NONATOMIC</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>我们在<code class="highlighter-rouge">Person(AssociatedObjects)</code>中增加了属性类型为NSString *的<code class="highlighter-rouge">associatedObjctName</code>,并用runtime的API实现了其setter和getter方法。我们再来运行下面代码:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
<span class="n">person</span><span class="p">.</span><span class="n">associatedObjcName</span> <span class="o">=</span> <span class="s">@"associated objects"</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"associatedObjcName: %@"</span><span class="p">,</span> <span class="n">person</span><span class="p">.</span><span class="n">associatedObjcName</span><span class="p">);</span>
    
<span class="n">id</span> <span class="n">personClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">person</span> <span class="nf">class</span><span class="p">];</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ivarNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">Ivar</span> <span class="o">*</span><span class="n">ivarArray</span> <span class="o">=</span> <span class="n">class_copyIvarList</span><span class="p">(</span><span class="n">personClass</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivarNumber</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">"Person objc_ivar_list: "</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ivarNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">Ivar</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">ivarArray</span><span class="p">[</span><span class="nf">i</span><span class="p">];</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%s, "</span><span class="p">,</span><span class="n">ivar_getName</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//输出为:
//associatedObjcName: associated objects
//Person objc_ivar_list: ivarName, _propertyName, 
</span><span class="o">//</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>我们可以看见<code class="highlighter-rouge">objc_ivar_list</code>并没有新加入的associated objects。</p>

<h3 id="runtime-api">2.2 在Runtime API中动态增加属性</h3>
<p>当用runtime API 动态创建类，添加方法和实例变量过程中，当类创建完毕后（调用<code class="highlighter-rouge">objc_registerClassPair</code>后）再用<code class="highlighter-rouge">class_addIvar(...)</code>添加的iVar不会出现在类的<code class="highlighter-rouge">objc_ivar_list</code>中，见如下代码。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></td><td class="code"><pre> <span class="c1">//dynamically create a Peron Class
</span> <span class="n">Class</span> <span class="n">person</span> <span class="o">=</span> <span class="n">objc_allocateClassPair</span><span class="p">([</span><span class="n">NSObject</span> <span class="nf">class</span><span class="p">],</span> <span class="s">"Person"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
     <span class="c1">// add a instance method
</span> <span class="n">Method</span> <span class="n">description</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">NSObject</span> <span class="nf">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="n">description</span><span class="p">));</span>
 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">methodType</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">description</span><span class="p">);</span>
 <span class="n">class_addMethod</span><span class="p">([</span><span class="n">person</span> <span class="nf">class</span><span class="p">],</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="s">@"greeting"</span><span class="p">),</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">greeting</span><span class="p">,</span> <span class="n">methodType</span><span class="p">);</span>
        <span class="c1">// add a instance variable before register
</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nameBeforeRegister</span> <span class="o">=</span> <span class="s">"nameBeforeRegister"</span><span class="p">;</span>
 <span class="n">class_addIvar</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">nameBeforeRegister</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">rint</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">))),</span> <span class="k">@encode</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
    
  <span class="c1">//register Person Class
</span> <span class="n">objc_registerClassPair</span><span class="p">(</span><span class="n">person</span><span class="p">);</span>
    
     <span class="c1">// add a instance variable after register
</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nameAfterRegister</span> <span class="o">=</span> <span class="s">"nameAfterRegister"</span><span class="p">;</span>
 <span class="n">class_addIvar</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">nameAfterRegister</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">rint</span><span class="p">(</span><span class="n">log2</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">id</span><span class="p">))),</span> <span class="k">@encode</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
    
 <span class="c1">//create a instance
</span> <span class="n">id</span> <span class="n">personInstance</span> <span class="o">=</span> <span class="p">[[</span><span class="n">person</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
     <span class="c1">//call the method
</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="p">((</span><span class="n">id</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span> <span class="n">SEL</span><span class="p">))</span><span class="n">objc_msgSend</span><span class="p">)(</span><span class="n">personInstance</span><span class="p">,</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="s">@"greeting"</span><span class="p">)));</span>
     <span class="c1">//dynamically add a variable(an associated object) to the personInstance and get it
</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">firstname</span> <span class="o">=</span> <span class="s">@"Johnson"</span><span class="p">;</span>
 <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">personInstance</span><span class="p">,</span> <span class="n">nameBeforeRegister</span><span class="p">,</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_COPY_NONATOMIC</span><span class="p">);</span>
 <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">personInstance</span><span class="p">,</span><span class="n">nameBeforeRegister</span><span class="p">));</span>
    
 <span class="n">NSString</span> <span class="o">*</span><span class="n">lastname</span> <span class="o">=</span> <span class="s">@"Lu"</span><span class="p">;</span>
 <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">personInstance</span><span class="p">,</span> <span class="n">nameAfterRegister</span><span class="p">,</span> <span class="n">lastname</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_COPY_NONATOMIC</span><span class="p">);</span>
 <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">personInstance</span><span class="p">,</span><span class="n">nameAfterRegister</span><span class="p">));</span>
    

    
 <span class="kt">int</span> <span class="n">ivarNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="n">Ivar</span> <span class="o">*</span><span class="n">ivars</span> <span class="o">=</span> <span class="n">class_copyIvarList</span><span class="p">([</span><span class="n">person</span> <span class="nf">class</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ivarNum</span><span class="p">);</span>
 <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ivarNum</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
     <span class="n">Ivar</span> <span class="n">ivar</span> <span class="o">=</span> <span class="n">ivars</span><span class="p">[</span><span class="nf">i</span><span class="p">];</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"%s "</span><span class="p">,</span><span class="n">ivar_getName</span><span class="p">(</span><span class="n">ivar</span><span class="p">));</span>
 <span class="p">}</span>
 <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="c1">//输出为:
//Hello World!
//Johnson
//Lu
//nameBeforeRegister 
</span><span class="o">//</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>可见当用runtime API动态创建类时，当创建完毕后，添加的iVar就不加入到<code class="highlighter-rouge">objc_ivar_list</code>.</p>

<h3 id="runtime-api-1">2.3. Runtime API介绍</h3>

<p>以上介绍了Associated Objects的实现，我们现在来看看其runtime API,包括以下3个方法：</p>

<ol>
  <li><code class="highlighter-rouge">objc_setAssociatedObject</code> 用于给对象添加关联对象，传入 nil 则可以移除已有的关联对象；</li>
  <li><code class="highlighter-rouge">objc_getAssociatedObject</code> 用于获取关联对象；</li>
  <li><code class="highlighter-rouge">objc_removeAssociatedObjects</code> 用于移除一个对象的所有关联对象。</li>
</ol>

<p>关于前两个函数中的 key 值是我们需要重点关注的一个点，一般来说，有以下三种推荐的 key 值：</p>

<ol>
  <li>声明 static char kAssociatedObjectKey; ，使用 &amp;kAssociatedObjectKey 作为 key 值;</li>
  <li>声明 static void *kAssociatedObjectKey = &amp;kAssociatedObjectKey; ，使用 kAssociatedObjectKey 作为 key 值；</li>
  <li>用 selector ，使用 getter 方法的名称作为 key 值。</li>
</ol>

<p>由于第3种方式最为优雅和简洁，在上面的例子中我们用的就是selector。</p>

<h2 id="section-1">3 总结</h2>
<p>Associated Objects用于扩展类的属性，使得外部在用dot notation存取属性时分不出两者的区别，这解决了Objective C属性扩展的问题。但是在内部实现中，Associated Objects和类本身的iVar和Property还是有区别的：</p>

<ol>
  <li>类的定义结束后(无论是Objective-C还是runtime API动态创建类)<code class="highlighter-rouge">objc_ivar_list</code>是不能变得。</li>
  <li>关联类和被关联类在内存中是分开存储的。被关联类的<code class="highlighter-rouge">objc_ivar_list</code>只存储其本身的iVar和Property。</li>
  <li>这同样体现在用runtime动态创建类中，<code class="highlighter-rouge">class_addIvar(...)</code>在<code class="highlighter-rouge">objc_registerClassPair</code>前和后调用时的情况。当<code class="highlighter-rouge">class_addIvar(...)</code>在<code class="highlighter-rouge">objc_registerClassPair</code>前调用时，加入的iVar是在类本身的定义中，存储在其<code class="highlighter-rouge">objc_ivar_list</code>；在<code class="highlighter-rouge">objc_registerClassPair</code>后调用，<code class="highlighter-rouge">class_addIvar(...)</code>，增加的iVar和本身的类分开存储。</li>
</ol>


            <div class="clearfix"></div>
        </div>


    
    <ul class="tag_box list-unstyled list-inline">
      <li><i class="fa fa-folder-open"></i></li>
      
      
      
        <li><a href="http://www.shunmian.me/categories.html#Objective-C-ref">
          Objective-C <span>(10)</span>
          
        </a></li>
      
      
    </ul>
    

    
    <ul class="list-inline">
      <li><i class="fa fa-tags"></i></li>
      
      
      
        <li>
          <a href="http://www.shunmian.me/tags.html#Associated Objects-ref">
          Associated Objects <span>(1)</span>
          
          </a>
        </li>
      
      
      
    </ul>
    

<hr />
<div >
    <section class="col-sm-7">
        <h4>Share Post</h4>
        <a class="btn btn-default btn-sm" href="http://twitter.com/share?text=OC Runtime(二)： Associated Objects&via=Wanderl29817400" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fa fa-twitter fa-sm"></i>
        Twitter
        </a>

        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-sm"></i>
          Facebook
        </a>

        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-sm"></i>
          Google+
        </a>
    </section>

    <section class="col-sm-5">
        <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df" class="img-rounded" />
        <h4>Shunmian</h4>
        <p class="author-bio">节物风光不相待，桑田碧海须臾改，唯有美食和code不可辜负。</p>

    </section>

</div>
<div class="clearfix"></div>

<ul class="pager">
    
    <li class="previous"><a href="http://www.shunmian.me/objective-c/2016/03/14/OC-Runtime(%E4%B8%80)_Sending-Message.html" title= "">&larr; Previous</a></li>
    
    
    <li class="next">"<a href="http://www.shunmian.me/objective-c/2016/03/16/OC-Runtime(%E4%B8%89)_method-swizzling.html" title= "OC Runtime(三)： Method Swizziling">Next &rarr;</a></li>
    
</ul>

    <hr />
    
    <section class="comments" style="margin-top:15px;">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shunmianjohnson'; // required: replace example with your forum shortname
        if(disqus_shortname){
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        }
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    </div>
    <div class="col-sm-1sidebar-2"></div>
    <div class="clearfix"></div>
</article>
<div class="clearfix"></div>


                <div class="footer">
                    <footer>
                        <hr />
                        <p> &copy: 2015 Shunmian with jekyll. Theme: <a href="https://github.com/dbtek/dbyll"dbyll</a> by dbtek.
                        </p>
                    </footer>
                </div>
            </div>
        </div>
    </div>


    <script src="/assets/js/jquery-2.2.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/script.js"></script>
    <script type="text/javascript">

$youziku.load(".sidebar_bio", "bdcc72b8235345649b02c123dac5610b", "SiYuan-ExtraLight");


   $youziku.draw();
</script>

</body>

</html>

