<!DOCTYPE html>
<html lang = "en">
<head>
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/posts/favico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/posts/favico/favico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/posts/favico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/posts/favico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/posts/favico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/posts/favico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/posts/favico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/posts/favico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/posts/favico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/posts/favico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/posts/favico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/images/posts/favico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/posts/favico/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/posts/favico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/images/posts/favico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">   

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/font-awesome/css/font-awesome.min.css">
    <link href="/assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
<!--     <script type="text/javascript" src="http://api.youziku.com/webfont/FastJS/yzk_976E121ED7CC0870"></script> -->

    <title>SHUNMIAN</title>
</head>


<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 sidebar hidden-xs sidebar">
                
<!--sidebar.html-->
        <header class="sidebar_header " role="banner">
            <a href="http://www.shunmian.me/index.html">
                <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df?s=150" class="img-circle img-responsive center-block sidebar_logo sidebar_img" />
            </a>


            <h3 class="title text-center">
                <a href="http://www.shunmian.me/index.html">SHUNMIAN</a>
            </h3>

        </header>


        <hr class="hr_short"/>
        <div id = "bio" class="text-center sidebar_bio">
            

                <p>嗨，欢迎来到我的博客。<br/>
                我是Shunmian，一名iOS开发者。<br/>
                <hr class = "hr_short_low">
                正在学习Algorithm，Functional Programming，Machine Learning，Data Mining 和 Cloud Computation。 

                </p>

            
        </div>


        <hr class="hr_middle"/>
        <div id = "contact-list" class="text-center">
            <ul class="list-unstyled list-inline">
                <li>
                    
                    <a class="btn btn_info_outline" href="mailto:shunmian@gmail.com"><i class="fa fa-envelope fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-github fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-twitter fa-lg"></i></a>
                    
                </li>

                <li>
                    <a class="btn btn_info_outline" href="http://www.shunmian.me/feed.xml"><i class="fa fa-rss fa-lg"></i></a>
                </li>
        </div>


        <hr class="hr_short"/>
        <div id = "contact-list" class="text-center">
            <ul class="unstyled-list list-inline">
                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/index.html"><i class="fa fa-home fa-md"></i> 主页</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/tags.html"><i class="fa fa-tags fa-md"></i> 标签</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/categories.html"><i class="fa fa-list fa-md"></i> 分类</a>
                </li>
            </ul>
        </div>
        <div class="padding_bottom_500"></div>




<!--sidebar.html end-->

            </div>

            <div class="col-sm-9 col-sm-offset-3">
                

<div class="page-header col-sm-10 col-sm-offset-1">
    <h1 class="article_mainTitle">OC Runtime(七)： Test3 </h1>
    <span class="post_date">
        2016-03-20 •
    </span>
    <span class="post_category">
        Objective-C
    </span>
</div>

<article class="article">
    <div class="col-sm-10 col-sm-offset-1">
        <div class="article_mainBody">
            <p class="article_content_title">目录</p>

<ul id="markdown-toc">
  <li><a href="#observing-pattern-" id="markdown-toc-observing-pattern-">1. Observing Pattern 介绍</a></li>
  <li><a href="#section" id="markdown-toc-section">2. 三种实现</a>    <ul>
      <li><a href="#section-1" id="markdown-toc-section-1">2.1 普通实现</a></li>
      <li><a href="#kvo-isa-swizzling" id="markdown-toc-kvo-isa-swizzling">2.2 KVO实现: isa Swizzling</a></li>
      <li><a href="#kvo-method-swizzling" id="markdown-toc-kvo-method-swizzling">2.3 KVO实现: Method Swizzling</a></li>
    </ul>
  </li>
  <li><a href="#section-2" id="markdown-toc-section-2">3 总结</a></li>
  <li><a href="#section-3" id="markdown-toc-section-3">4 参考资料</a></li>
</ul>

<hr class="hr-short-left" />

<h2 id="observing-pattern-">1. Observing Pattern 介绍</h2>

<p>Obeserving Pattern 是Gang Of Four里面提到的24种面向对象设计模式之一。使得subject(被观察者)的iVar改变的时候，observer(观察者)能够得到提醒。这里有一个tricky的地方是beginner刚开始思考这个问题的时候，observer如果一直主动观察着subject iVar的变化，那observer就干不了其他事情了，或者另开一个线程。而问题的解决方法其实是observer被动接受subject发出的iVar的变化， 即subject拥有observer的引用，在iVar的setter里提醒observer。</p>

<p class="img_middle_lg"><img src="/assets/images/posts/2016-03-17/Observer Pattern.png" alt="SendingMessage" /></p>

<p>上图是Observing Pattern的UML。Subject是一个接口，声明了三个方法：</p>

<ol>
  <li><code class="highlighter-rouge">addObserver(Observer)</code>, 注册observer(即将observer加入到observers数组)；</li>
  <li><code class="highlighter-rouge">notify()</code>, 通知observers(observers数组里的每个observer都调用其update()方法)；</li>
  <li><code class="highlighter-rouge">removeObserver(Observer)</code>, 注销observer(即observers数组里删除observer)。</li>
</ol>

<p>Observer也是一个接口，声明了一个方法：<code class="highlighter-rouge">update()</code>,用来Subject iVar改变时响应。</p>

<p><code class="highlighter-rouge">ConcreteSubjectA</code>实现了<code class="highlighter-rouge">Subject</code>接口，在iVar的setter里加了<code class="highlighter-rouge">notify()</code>, 因此在每一次iVar值改变时，都会提醒observers里的每一个<code class="highlighter-rouge">Observer</code>相应<code class="highlighter-rouge">update()</code>。<code class="highlighter-rouge">ConcreteObserver</code>实现了<code class="highlighter-rouge">Observer</code>接口。这个UML理解起来比较清晰。</p>

<h2 id="section">2. 三种实现</h2>

<p>我们知道Objective C对 Observer Pattern的实现是用Key Value Observeing(KVO)。我们下面用三种方法在Objective C中实现Observer Pattern：普通实现(即按照上面UML图来实现)， isa Swizzling实现KVO， method Swizzling实现KVO。</p>

<h3 id="section-1">2.1 普通实现</h3>

<p>普通实现比较简单，代码如下</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></td><td class="code"><pre><span class="k">@implementation</span> <span class="nc">ConcreteSubjectA</span>

<span class="k">-</span><span class="p">(</span><span class="n">NSMutableArray</span> <span class="o">*</span><span class="p">)</span><span class="n">Observers</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">_Observers</span><span class="p">){</span>
        <span class="n">_Observers</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nf">array</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">_Observers</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">LAL_addObserver</span><span class="o">:</span><span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">LAL_Observer</span><span class="o">&gt;</span><span class="p">)</span><span class="n">observer</span> <span class="n">WithBlock</span><span class="o">:</span><span class="p">(</span><span class="n">LALObservingBlock</span><span class="p">)</span><span class="n">block</span><span class="p">{</span>
    <span class="p">[</span><span class="n">observer</span> <span class="nf">setObservingBlock</span><span class="p">:</span><span class="n">block</span><span class="p">];</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">Observers</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">observer</span><span class="p">];</span>

<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">LAL_notify</span><span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">LAL_Observer</span><span class="o">&gt;</span> <span class="n">observer</span> <span class="k">in</span> <span class="n">self</span><span class="p">.</span><span class="n">Observers</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">observer</span> <span class="nf">LAL_update</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">LAL_removeObserver</span><span class="o">:</span><span class="p">(</span><span class="n">id</span><span class="o">&lt;</span><span class="n">LAL_Observer</span><span class="o">&gt;</span><span class="p">)</span><span class="n">observer</span><span class="p">{</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">Observers</span> <span class="nf">removeObject</span><span class="p">:</span><span class="n">observer</span><span class="p">];</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">setAge</span><span class="o">:</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="n">age</span><span class="p">{</span>
    <span class="n">_age</span> <span class="o">=</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span> <span class="nf">LAL_notify</span><span class="p">];</span><span class="c1">//iVar age 改变后通知Observers.
</span><span class="p">}</span>
<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>在这里，重写age的setter，加入通知Observers是关键。</p>

<h3 id="kvo-isa-swizzling">2.2 KVO实现: isa Swizzling</h3>
<p>对于熟悉Key Value Observing API的同学来说，“订阅”-“响应”-“取消订阅” 也对应着上述<code class="highlighter-rouge">addObserver(Observer)</code>,<code class="highlighter-rouge">notify()</code>和<code class="highlighter-rouge">removeObserver(Observer)</code>这三个步骤，具体请参考<a href="http://www.shunmian.me/objective-c/2016/02/18/Key-Value-Observing.html" target="_blank">Key Value Observing</a>。</p>

<ol>
  <li>
    <p>订阅：<code class="highlighter-rouge">- (void)addObserver:forKeyPath:options:context:</code></p>
  </li>
  <li>
    <p>响应：<code class="highlighter-rouge">- (void)observeValueForKeyPath: ofObject:change:context:</code></p>
  </li>
  <li>
    <p>取消订阅：<code class="highlighter-rouge">- (void)removeObserver:forKeyPath:</code></p>
  </li>
</ol>

<p>令人疑惑的是KVO缺少改写Subject iVar setter这一步，而这一步正是Observing Pattern的关键。Apple是如何做到这一步的呢，我们来看下<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/Articles/KVOImplementation.html#//apple_ref/doc/uid/20002307-BAJEAIEE" target="_blank">Introduction to Key-Value Observing Programming Guide</a>对于KVO实现原理的介绍：</p>

<blockquote>
  <p><b>Key-Value Observing Implementation Details</b>: Automatic key-value observing is implemented using a technique called isa-swizzling.The isa pointer, as the name suggests, points to the object’s class which maintains a dispatch table. This dispatch table essentially contains pointers to the methods the class implements, among other data.When an observer is registered for an attribute of an object the isa pointer of the observed object is modified, pointing to an intermediate class rather than at the true class. As a result the value of the isa pointer does not necessarily reflect the actual class of the instance.You should never rely on the isa pointer to determine class membership. Instead, you should use the class method to determine the class of an object instance.</p>
</blockquote>

<p>Apple用了一种isa Swizzling的方法，创建了一个中间类，使得原来的类变成中间类的父类，原来的实例变成中间类的实例;并改写了其class方法，返回依然是原来的类用来欺骗开发者。这样的做法有两个好处：</p>

<ol>
  <li>开发者专注于“订阅”-“响应”-“取消订阅”API,而无需关注重写iVar setter， 重写由KVO自己完成；</li>
  <li>isa Swizzling创建了中间类，因此原来的类的实现细节不会由于KVO而改变, KVO的改变体现在中间类里。这体现了封装和扩展的思想。</li>
</ol>

<p>下面我们就来自行实现以下KVO用isa Swizzling的方法。我们给NSObject创建一个KVO匿名类，里面有两个方法，订阅和取消订阅,并且声明了一个LALKVOBlock类型，用来响应(官方KVO没有支持block或者selector,所有响应逻辑都在<code class="highlighter-rouge">-(void)observeValueForKeyPath:ofObject:change:context:</code>里执行，这也是官方KVO广为诟病的一个原因)：</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">LALKVOBlock</span><span class="p">)(</span><span class="n">id</span> <span class="n">obsever</span><span class="p">,</span> <span class="n">id</span> <span class="n">subject</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">keyPath</span><span class="p">,</span> <span class="n">id</span> <span class="n">oldValue</span><span class="p">,</span> <span class="n">id</span> <span class="n">newValue</span><span class="p">);</span>

<span class="k">@interface</span> <span class="nc">NSObject</span> <span class="p">(</span><span class="nl">LALKVO</span><span class="p">)</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_addObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">withBlock</span><span class="p">:(</span><span class="n">LALKVOBlock</span><span class="p">)</span><span class="nv">block</span><span class="p">;</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_removeObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span><span class="p">;</span>

<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><code class="highlighter-rouge">-(void)LALKVO_addObserver:ForKeyPath:withBlock:</code>主要逻辑如下:</p>

<ol>
  <li>keyPath是否有效;</li>
  <li>若有效则看中间类是否存在,若不存在则创建(实例isa指向中间类，中间类的super_class指向原类，并改写实例的class方法，使其指向原类)；</li>
  <li>keyPath对应的setter中间类是否已经重写，若没有则重写；</li>
  <li>增加observer到observers数组。</li>
</ol>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></td><td class="code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_addObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">withBlock</span><span class="p">:(</span><span class="n">__autoreleasing</span> <span class="n">LALKVOBlock</span><span class="p">)</span><span class="nv">block</span><span class="p">{</span>
    <span class="c1">//assume the original class is Person
</span>    <span class="n">Class</span> <span class="n">originalClass</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">class</span><span class="p">];</span>
    
    <span class="c1">//step1: keyPath is valid or not.
</span>    <span class="n">SEL</span> <span class="n">keyPathSetter</span> <span class="o">=</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">setterForGetter</span><span class="p">(</span><span class="n">keyPath</span><span class="p">));</span>
    <span class="n">Method</span> <span class="n">keyPathSetterMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">originalClass</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">keyPathSetterMethod</span><span class="p">){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"the keyPath is not valid!"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">//step2: intermediate Class exist or not, if not create it LALKVO_Person as the intermediate Class.
</span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">originalClassName</span> <span class="o">=</span> <span class="n">class_getName</span><span class="p">(</span><span class="n">originalClass</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">intermediateClassName</span> <span class="o">=</span> <span class="n">getIntermediateClassName</span><span class="p">(</span><span class="n">originalClassName</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">objc_getClass</span><span class="p">(</span><span class="n">intermediateClassName</span><span class="p">)){</span>
        <span class="n">createIntermediateClass</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">originalClassName</span><span class="p">,</span> <span class="n">intermediateClassName</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">//step3: override the setter in LALKVO_Person.
</span>        <span class="c1">//LALKVO_Person 是否有setter
</span>    <span class="n">Class</span> <span class="n">intermediateClass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hasSelector</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">)){</span>
        <span class="c1">//没有则创建.
</span>        <span class="n">Method</span> <span class="n">originalKeyPathSetterMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">originalClass</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">types</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">originalKeyPathSetterMethod</span><span class="p">);</span>
        <span class="n">class_addMethod</span><span class="p">(</span><span class="n">intermediateClass</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">,</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">kvo_setter</span><span class="p">,</span> <span class="n">types</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//setp4: add the observer to the subject.
</span>    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">observeInfoArray</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">observeInfoArray</span><span class="p">){</span>
        <span class="n">observeInfoArray</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
        <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">,</span> <span class="n">observeInfoArray</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ObserveInfo</span> <span class="o">*</span><span class="n">observeInfo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ObserveInfo</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithSubject</span><span class="p">:</span><span class="n">self</span> <span class="nf">keyPath</span><span class="p">:</span><span class="n">keyPath</span> <span class="n">observer</span><span class="o">:</span><span class="n">observer</span> <span class="n">block</span><span class="o">:</span><span class="n">block</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">observeInfoArrayContainsObserveInfo</span><span class="p">(</span><span class="n">observeInfoArray</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">)){</span>
        <span class="p">[</span><span class="n">observeInfoArray</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">observeInfo</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>其中最关键的是第三步，获取原类的setter IMP,执行它，代码如下:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></td><td class="code"><pre><span class="kt">void</span> <span class="n">kvo_setter</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">id</span> <span class="n">newValue</span><span class="p">){</span>
    
    <span class="n">NSString</span> <span class="o">*</span><span class="n">setterName</span> <span class="o">=</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">);</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">getterName</span> <span class="o">=</span> <span class="n">getterForSetter</span><span class="p">(</span><span class="n">setterName</span><span class="p">);</span>
    
    <span class="c1">//get the originalClass getter IMP and implement it.
</span>    <span class="n">Method</span> <span class="n">getterMethodFromOriginalClass</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">obj</span><span class="p">)),</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">getterName</span><span class="p">));</span>
    <span class="n">IMP</span> <span class="n">getterIMPFromOriginalClass</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">getterMethodFromOriginalClass</span><span class="p">);</span>
    <span class="n">id</span> <span class="p">(</span><span class="o">*</span><span class="n">getterIMPFromOriginalClassCasted</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span><span class="n">SEL</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">getterIMPFromOriginalClass</span><span class="p">;</span>
    <span class="n">id</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">getterIMPFromOriginalClassCasted</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">getterName</span><span class="p">));</span>
    
    
    <span class="c1">//get the originalClass setter IMP, and implement it.
</span>    <span class="n">Method</span> <span class="n">setterMethodFromOriginalClass</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">obj</span><span class="p">)),</span> <span class="n">_cmd</span><span class="p">);</span>
    <span class="n">IMP</span> <span class="n">setterIMPFromOriginalClass</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">setterMethodFromOriginalClass</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setterIMPFromOriginalClassCasted</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span> <span class="n">SEL</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">setterIMPFromOriginalClass</span><span class="p">;</span>
    <span class="n">setterIMPFromOriginalClassCasted</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">newValue</span><span class="p">);</span>
    
    <span class="c1">//call the block for each observer.
</span>    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">observerInfoArray</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ObserveInfo</span> <span class="o">*</span><span class="n">observeInfo</span> <span class="k">in</span> <span class="n">observerInfoArray</span><span class="p">){</span>
        <span class="k">if</span><span class="p">([</span><span class="n">observeInfo</span><span class="p">.</span><span class="n">keyPath</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="n">getterName</span><span class="p">]){</span>
            <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
                <span class="n">observeInfo</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="n">observeInfo</span><span class="p">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">.</span><span class="n">keyPath</span><span class="p">,</span> <span class="n">oldValue</span><span class="p">,</span> <span class="n">newValue</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>源码在这里。</p>

<h3 id="kvo-method-swizzling">2.3 KVO实现: Method Swizzling</h3>

<p>不知道同学们注意到没有，其实isa Swizzling实现KVO的本质是创建中间类，然后在中间类的setter里用Method Swizzling重写。Method Swizzling的介绍请见传送门<a href="http://www.shunmian.me/objective-c/2016/03/16/OC-Runtime(三)_method-swizzling.html" target="_blank">OC Runtime(三)： Method Swizziling</a>。创建中间类的好处是使得原类的实现不被KVO改变。实际上我们完全可以不用isa Swizlling而只用Method Swizzling来实现KVO, 代码如下:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">LALKVOBlock</span><span class="p">)(</span><span class="n">id</span> <span class="n">obsever</span><span class="p">,</span> <span class="n">id</span> <span class="n">subject</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">keyPath</span><span class="p">,</span> <span class="n">id</span> <span class="n">oldValue</span><span class="p">,</span> <span class="n">id</span> <span class="n">newValue</span><span class="p">);</span>
<span class="k">static</span> <span class="n">NSNumber</span> <span class="o">*</span><span class="n">LALKVO_overrideKeyPathSetterFlag</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">originalSetterIMP</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span> <span class="n">SEL</span><span class="p">,</span><span class="n">id</span><span class="p">);</span>

<span class="k">@interface</span> <span class="nc">NSObject</span> <span class="p">(</span><span class="nl">LALKVO</span><span class="p">)</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_addObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">withBlock</span><span class="p">:(</span><span class="n">LALKVOBlock</span><span class="p">)</span><span class="nv">block</span><span class="p">;</span>
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_removeObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span><span class="p">;</span>

<span class="k">+</span><span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="n">overrideFlag</span><span class="p">;</span>
<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setOverrideFlag</span><span class="p">:(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="nv">flag</span><span class="p">;</span>
<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>我们增加了一个静态类变量来标志setter是否被重写，并且实现了该类变量的setter和getter。同时我们设置了一个静态函数指针用来存储原来的setter的实现。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">LALKVO_addObserver</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">observer</span> <span class="nf">ForKeyPath</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">keyPath</span> <span class="nf">withBlock</span><span class="p">:(</span><span class="n">__autoreleasing</span> <span class="n">LALKVOBlock</span><span class="p">)</span><span class="nv">block</span><span class="p">{</span>
    
    <span class="n">Class</span> <span class="n">originalClass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="c1">//step1: keyPath is valid or not
</span>    <span class="n">SEL</span> <span class="n">keyPathSetter</span> <span class="o">=</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">setterForGetter</span><span class="p">(</span><span class="n">keyPath</span><span class="p">));</span>
    <span class="n">Method</span> <span class="n">keyPathSetterMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">originalClass</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">keyPathSetterMethod</span><span class="p">){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"the keyPath is not valid!"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//step2: override the setter class, 查看overrideFlag
</span>        <span class="c1">//self 是否已经改写setter
</span>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">[[</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="nf">overrideFlag</span><span class="p">]</span> <span class="nf">boolValue</span><span class="p">]){</span>
        <span class="c1">//获取original Setter Method and IMP
</span>        <span class="n">Method</span> <span class="n">originalKeyPathSetterMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">originalClass</span><span class="p">,</span> <span class="n">keyPathSetter</span><span class="p">);</span>
        <span class="n">originalSetterIMP</span> <span class="o">=</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">originalKeyPathSetterMethod</span><span class="p">);</span>

        <span class="n">method_setImplementation</span><span class="p">(</span><span class="n">originalKeyPathSetterMethod</span><span class="p">,</span> <span class="p">(</span><span class="n">IMP</span><span class="p">)</span><span class="n">kvo_setter</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// setp3: add the observer to the subject.
</span>    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">observeInfoArray</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">observeInfoArray</span><span class="p">){</span>
        <span class="n">observeInfoArray</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
        <span class="n">objc_setAssociatedObject</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">,</span> <span class="n">observeInfoArray</span><span class="p">,</span> <span class="n">OBJC_ASSOCIATION_RETAIN_NONATOMIC</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ObserveInfo</span> <span class="o">*</span><span class="n">observeInfo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ObserveInfo</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithSubject</span><span class="p">:</span><span class="n">self</span> <span class="nf">keyPath</span><span class="p">:</span><span class="n">keyPath</span> <span class="n">observer</span><span class="o">:</span><span class="n">observer</span> <span class="n">block</span><span class="o">:</span><span class="n">block</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">observeInfoArrayContainsObserveInfo</span><span class="p">(</span><span class="n">observeInfoArray</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">)){</span>
        <span class="p">[</span><span class="n">observeInfoArray</span> <span class="nf">addObject</span><span class="p">:</span><span class="n">observeInfo</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>kvo_setter的code如下:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></td><td class="code"><pre><span class="kt">void</span> <span class="n">kvo_setter</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">id</span> <span class="n">newValue</span><span class="p">){</span>
    
    <span class="n">NSString</span> <span class="o">*</span><span class="n">setterName</span> <span class="o">=</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">_cmd</span><span class="p">);</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">getterName</span> <span class="o">=</span> <span class="n">getterForSetter</span><span class="p">(</span><span class="n">setterName</span><span class="p">);</span>
    
    <span class="c1">//get the class getter IMP, and implement it.
</span>    <span class="n">Method</span> <span class="n">getterMethodFromOriginalClass</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">object_getClass</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">getterName</span><span class="p">));</span>
    <span class="n">IMP</span> <span class="n">getterIMPFromOriginalClass</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">getterMethodFromOriginalClass</span><span class="p">);</span>
    <span class="n">id</span> <span class="p">(</span><span class="o">*</span><span class="n">getterIMPFromOriginalClassCasted</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span><span class="n">SEL</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">getterIMPFromOriginalClass</span><span class="p">;</span>
    <span class="n">id</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">getterIMPFromOriginalClassCasted</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">getterName</span><span class="p">));</span>
    
    <span class="c1">//get the class setter IMP, and implement it.
</span>    <span class="n">originalSetterIMP</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_cmd</span><span class="p">,</span> <span class="n">newValue</span><span class="p">);</span>
    
    <span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">observerInfoArray</span> <span class="o">=</span> <span class="n">objc_getAssociatedObject</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">kLALKVOObserverInfoArray</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ObserveInfo</span> <span class="o">*</span><span class="n">observeInfo</span> <span class="k">in</span> <span class="n">observerInfoArray</span><span class="p">){</span>
        <span class="k">if</span><span class="p">([</span><span class="n">observeInfo</span><span class="p">.</span><span class="n">keyPath</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="n">getterName</span><span class="p">]){</span>
            <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
                <span class="n">observeInfo</span><span class="p">.</span><span class="n">block</span><span class="p">(</span><span class="n">observeInfo</span><span class="p">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">.</span><span class="n">subject</span><span class="p">,</span> <span class="n">observeInfo</span><span class="p">.</span><span class="n">keyPath</span><span class="p">,</span> <span class="n">oldValue</span><span class="p">,</span> <span class="n">newValue</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">LALKVO_overrideKeyPathSetterFlag</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="nf">numberWithBool</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>源码在这里。</p>

<h2 id="section-2">3 总结</h2>
<p>本文用三种方法在Objective-C里实现了Observing Pattern, 包括普通实现，KVO isa Swizlling实现和KVO Method Swizzling实现。后两种需要读者对Objective-C的runtime有一定的熟悉。通过自己实现KVO的主要功能，相信定会让你更能体会代码的乐趣和增加自己coding的信心。</p>

<h2 id="section-3">4 参考资料</h2>
<ul>
  <li>
    <p><a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Key-Value Observing Programming Guide</a>;</p>
  </li>
  <li>
    <p><a href="http://tech.glowing.com/cn/implement-kvo/">如何自己动手实现 KVO</a>;</p>
  </li>
  <li>
    <p><a href="http://zhangbuhuai.com/2015/04/29/understanding-KVO/">深入理解KVO</a>;</p>
  </li>
</ul>


            <div class="clearfix"></div>
        </div>


    
    <ul class="tag_box list-unstyled list-inline">
      <li><i class="fa fa-folder-open"></i></li>
      
      
      
        <li><a href="http://www.shunmian.me/categories.html#Objective-C-ref">
          Objective-C <span>(10)</span>
          
        </a></li>
      
      
    </ul>
    

    
    <ul class="list-inline">
      <li><i class="fa fa-tags"></i></li>
      
      
      
        <li>
          <a href="http://www.shunmian.me/tags.html#isa Swizzling-ref">
          isa Swizzling <span>(4)</span>
          
          </a>
        </li>
      
      
      
    </ul>
    

<hr />
<div >
    <section class="col-sm-7">
        <h4>Share Post</h4>
        <a class="btn btn-default btn-sm" href="http://twitter.com/share?text=OC Runtime(七)： Test3&via=Wanderl29817400" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fa fa-twitter fa-sm"></i>
        Twitter
        </a>

        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-sm"></i>
          Facebook
        </a>

        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-sm"></i>
          Google+
        </a>
    </section>

    <section class="col-sm-5">
        <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df" class="img-rounded" />
        <h4>Shunmian</h4>
        <p class="author-bio">节物风光不相待，桑田碧海须臾改，唯有美食和code不可辜负。</p>

    </section>

</div>
<div class="clearfix"></div>

<ul class="pager">
    
    <li class="previous"><a href="http://www.shunmian.me/objective-c/2016/03/19/OC-Runtime(%E5%85%AD)_iVar-and-Property.html" title= "">&larr; Previous</a></li>
    
    
    <li class="next disabled"><a>Next &rarr;</a></li>
    
</ul>

    <hr />
    
    <section class="comments" style="margin-top:15px;">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shunmianjohnson'; // required: replace example with your forum shortname
        if(disqus_shortname){
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        }
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    </div>
    <div class="col-sm-1sidebar-2"></div>
    <div class="clearfix"></div>
</article>
<div class="clearfix"></div>


                <div class="footer">
                    <footer>
                        <hr />
                        <p> &copy: 2015 Shunmian with jekyll. Theme: <a href="https://github.com/dbtek/dbyll"dbyll</a> by dbtek.
                        </p>
                    </footer>
                </div>
            </div>
        </div>
    </div>


    <script src="/assets/js/jquery-2.2.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/script.js"></script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

    <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
    <script type="text/javascript">

$youziku.load(".sidebar_bio", "bdcc72b8235345649b02c123dac5610b", "SiYuan-ExtraLight");


   $youziku.draw();
</script>

</body>

</html>

