<!DOCTYPE html>
<html lang = "en">
<head>
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/posts/favico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/posts/favico/favico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/posts/favico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/posts/favico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/posts/favico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/posts/favico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/posts/favico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/posts/favico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/posts/favico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/posts/favico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/posts/favico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/images/posts/favico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/posts/favico/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/posts/favico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/images/posts/favico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">   

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/font-awesome/css/font-awesome.min.css">
    <link href="/assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
<!--     <script type="text/javascript" src="http://api.youziku.com/webfont/FastJS/yzk_976E121ED7CC0870"></script> -->

    <title>SHUNMIAN</title>
</head>


<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 sidebar hidden-xs sidebar">
                
<!--sidebar.html-->
        <header class="sidebar_header " role="banner">
            <a href="http://www.shunmian.me/index.html">
                <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df?s=150" class="img-circle img-responsive center-block sidebar_logo sidebar_img" />
            </a>


            <h3 class="title text-center">
                <a href="http://www.shunmian.me/index.html">SHUNMIAN</a>
            </h3>

        </header>


        <hr class="hr_short"/>
        <div id = "bio" class="text-center sidebar_bio">
            

                <p>嗨，欢迎来到我的博客。<br/>
                我是Shunmian，一名iOS开发者。<br/>
                <hr class = "hr_short_low">
                正在学习Algorithm，Functional Programming，Machine Learning，Data Mining 和 Cloud Computation。 

                </p>

            
        </div>


        <hr class="hr_middle"/>
        <div id = "contact-list" class="text-center">
            <ul class="list-unstyled list-inline">
                <li>
                    
                    <a class="btn btn_info_outline" href="mailto:shunmian@gmail.com"><i class="fa fa-envelope fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-github fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-twitter fa-lg"></i></a>
                    
                </li>

                <li>
                    <a class="btn btn_info_outline" href="http://www.shunmian.me/feed.xml"><i class="fa fa-rss fa-lg"></i></a>
                </li>
        </div>


        <hr class="hr_short"/>
        <div id = "contact-list" class="text-center">
            <ul class="unstyled-list list-inline">
                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/index.html"><i class="fa fa-home fa-md"></i> 主页</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/tags.html"><i class="fa fa-tags fa-md"></i> 标签</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/categories.html"><i class="fa fa-list fa-md"></i> 分类</a>
                </li>
            </ul>
        </div>
        <div class="padding_bottom_500"></div>




<!--sidebar.html end-->

            </div>

            <div class="col-sm-9 col-sm-offset-3">
                

<div class="page-header col-sm-10 col-sm-offset-1">
    <h1 class="article_mainTitle">OC Runtime(三)： Method Swizziling </h1>
    <span class="post_date">
        2016-03-16 •
    </span>
    <span class="post_category">
        Objective-C
    </span>
</div>

<article class="article">
    <div class="col-sm-10 col-sm-offset-1">
        <div class="article_mainBody">
            <p class="article_content_title">目录</p>

<ul id="markdown-toc">
  <li><a href="#method-swizzling-" id="markdown-toc-method-swizzling-">1. Method Swizzling 介绍</a></li>
  <li><a href="#method-swizzling-code" id="markdown-toc-method-swizzling-code">2. Method Swizzling code</a>    <ul>
      <li><a href="#api" id="markdown-toc-api">2.1 API</a></li>
      <li><a href="#nsstring-lowercase-uppercase" id="markdown-toc-nsstring-lowercase-uppercase">2.2 应用1: NSString lowerCase upperCase方法的交换</a></li>
      <li><a href="#uiviewcontroller" id="markdown-toc-uiviewcontroller">2.3 应用2: 打印当前UIViewController的名字</a></li>
      <li><a href="#section" id="markdown-toc-section">2.4 注意点</a></li>
    </ul>
  </li>
  <li><a href="#section-1" id="markdown-toc-section-1">3 总结</a></li>
</ul>

<hr class="hr-short-left" />

<h2 id="method-swizzling-">1. Method Swizzling 介绍</h2>

<p>首先回顾一下Objective-C 消息发送过程:</p>

<p class="img_middle_lg"><img src="/assets/images/posts/2016-03-16/sending message.png" alt="SendingMessage" /></p>

<p>简单来看下这张图，当<code class="highlighter-rouge">[foo doSomething:@"param1" and @"param2"]</code>执行时，会转换成<code class="highlighter-rouge">objc_msgSend(id foo, SEL @selector(doSomething:and:),@"param1",@"param2")</code>, 而这个函数的执行过程就是这张图的流程:</p>

<ul class="nestedList">
  <li>1 调用 <code class="highlighter-rouge">IMP lookUpImpOrNil(Class cls, SEL name)</code>
    <ul>
      <li>1.1 查找<code class="highlighter-rouge">foo</code>的<code class="highlighter-rouge">isa</code>，通过<code class="highlighter-rouge">@selector(doSomething:and:)</code>查找<code class="highlighter-rouge">cache</code>，若找不到则下一步;</li>
      <li>1.2 查找vtable，最终找到函数的实现, 类型为IMP的函数指针,若找不到则调到2;</li>
    </ul>
  </li>
  <li>2 消息转发，
    <ul>
      <li>2.1 <code class="highlighter-rouge">+ (BOOL) resolveInstanceMethod:(SEL)sel</code>, 如找不到则2.2;</li>
      <li>2.2 <code class="highlighter-rouge">-(id)forwardingTargetForSelector:(SEL)sel</code>, 如找不到则2.3;</li>
      <li>2.3 <code class="highlighter-rouge">-(void)forwardInvocation:(NSInvocation *)inv</code>, 如找不到则2.4;</li>
      <li>2.4 <code class="highlighter-rouge">-(void)doesNotRecognizeSelector:(SEL)sel</code>。</li>
    </ul>
  </li>
</ul>

<p>这个过程中，swizzling可以发生在:</p>

<ul>
  <li>1.1 调换isa(isa Swizzling)来达到查找IMP的目的(如Objective-C对KVO的实现,原类没有改写setter，如何实现KVO，关键在于isa swizzling创建了一个中间类，重写了setter，这个我们以后的文章再详细讲);</li>
  <li>1.2 调换@selector和IMP在vtable上的对应关系(Method Swizzling)来动态实现selector和IMP的绑定。</li>
</ul>

<p>介绍了消息发送之后，我们来具体看看Method Swizzling。 既然是Method Swizziling，那什么是<code class="highlighter-rouge">Method</code>呢，在<code class="highlighter-rouge">/usr/include/objc</code>中的我们可以找到这样的定义:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="n">objc_method</span> <span class="o">*</span><span class="n">Method</span>
<span class="k">struct</span> <span class="n">objc_method</span> <span class="p">{</span>
	<span class="n">SEL</span> <span class="n">method_name</span>       <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span> <span class="c1">//method 的 selector，SEL
</span>	<span class="kt">char</span> <span class="o">*</span><span class="n">method_types</span>    <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span> <span class="c1">//method 的 输入输出参数类型, signature
</span>	<span class="n">IMP</span> <span class="n">method_imp</span>        <span class="n">OBJC2_UNAVAILABLE</span><span class="p">;</span> <span class="c1">//method 的 实现，IMP
</span><span class="p">}</span> <span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>一个Method是一个指向objc_method结构体的指针，这个结构体包含三个变量，分别是SEL，signature和IMP。一个vtalbe的entry既是Method, 第一列是SEL,第二列是IMP。一个SEL对应一个IMP，如下图。</p>

<p class="img_middle_mid"><img src="/assets/images/posts/2016-03-16/vtable1.png" alt="vtable1" />
<img src="/assets/images/posts/2016-03-16/vtable2.png" alt="vtable2" /></p>

<p>因此，如果你可以更改SEL和IMP的动态对应关系，则可以做出一些奇妙的事情。</p>

<h2 id="method-swizzling-code">2. Method Swizzling code</h2>

<h3 id="api">2.1 API</h3>
<p>我们来建一个Swzizzle类，代码如下:</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></td><td class="code"><pre><span class="n">Swizzle</span><span class="p">.</span><span class="n">h</span>

<span class="cp"># import &lt;Foundation/Foundation.h&gt;
# import &lt;objc/runtime.h&gt;
</span><span class="k">@interface</span> <span class="nc">Swizzle</span> <span class="p">:</span> <span class="nc">NSObject</span>
<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">swizzleClass</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">objecClass</span> <span class="nf">fromSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">sel1</span> <span class="nf">toSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">sel2</span><span class="p">;</span>
<span class="k">@end</span>


<span class="n">Swizzle</span><span class="p">.</span><span class="n">m</span>

<span class="k">@implementation</span> <span class="nc">Swizzle</span>


<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">swizzleClass</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">objecClass</span> <span class="nf">fromSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">sel1</span> <span class="nf">toSelector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">sel2</span><span class="p">{</span>
	<span class="k">static</span> <span class="n">dispatch_once_t</span> <span class="n">onceToken</span><span class="p">;</span>
	<span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
	    <span class="n">Method</span> <span class="n">originalMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">objecClass</span><span class="p">,</span> <span class="n">sel1</span><span class="p">);</span>
	    <span class="n">Method</span> <span class="n">destinationMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">objecClass</span><span class="p">,</span> <span class="n">sel2</span><span class="p">);</span>
	
	    <span class="n">IMP</span> <span class="n">originIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">);</span>
	    <span class="n">IMP</span> <span class="n">destinationIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">destinationMethod</span><span class="p">);</span>
	
	    <span class="n">BOOL</span> <span class="n">isAdded</span> <span class="o">=</span> <span class="n">class_addMethod</span><span class="p">(</span><span class="n">objecClass</span><span class="p">,</span> <span class="n">sel1</span><span class="p">,</span> <span class="n">destinationIMP</span><span class="p">,</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">destinationMethod</span><span class="p">));</span>
	
	    <span class="k">if</span><span class="p">(</span><span class="n">isAdded</span><span class="p">){</span>
	        <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">objecClass</span><span class="p">,</span> <span class="n">sel2</span><span class="p">,</span> <span class="n">originIMP</span><span class="p">,</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">));</span>
	    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
	        <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">originalMethod</span><span class="p">,</span> <span class="n">destinationMethod</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">});</span>
<span class="p">}</span>
<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Swizzle类只有一个类方法<code class="highlighter-rouge">+(void)swizzleClass:(id)objecClass fromSelector:(SEL)sel1 toSelector:(SEL)sel2</code>,返回void, 输入第一参数是要执行method swizzle的类名，第二个和第三个参数是要交换的selector。</p>

<p>首先我们获取两个selector对应的method(<code class="highlighter-rouge">class_getInstanceMethod)</code>, 然后通过method获取其IMP(<code class="highlighter-rouge">method_getImplementation</code>)。
然后我们在原本的类里尝试添加新的方法，该方法的selector是sel1，IMP是destinationIMP，返回一个bool值表示是否添加成功。如果添加成功，则将原来的method2替换掉(<code class="highlighter-rouge">class_replaceMethod</code>), 令其sel2指向IMP2。若果失败，则表示类里面已经存在method1，那么就简单将method1和method2的IMP交换既可。这样就防止了一种情况：该类继承于父类，却没有重写父类的方法，如果简单用<code class="highlighter-rouge">method_exchangeImplementations(originalMethod, destinationMethod)</code>,则会将父类的originalMethod的IMP和该类的destinationMethod的IMP交换，这不是我们想要的。
用GCD的<code class="highlighter-rouge">dispatch_once</code>方法是为了保证线程安全且交换只执行一次。</p>

<h3 id="nsstring-lowercase-uppercase">2.2 应用1: NSString lowerCase upperCase方法的交换</h3>
<p>好了我们来看看如何用这个Swizzle,</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre></td><td class="code"><pre><span class="n">NSString</span> <span class="o">*</span><span class="n">originalString</span> <span class="o">=</span> <span class="s">@"hello,WORLD!"</span><span class="p">;</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"original string  : %@"</span><span class="p">,</span><span class="n">originalString</span><span class="p">);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"before Method Swizzle---------"</span><span class="p">);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"lower case String: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">originalString</span> <span class="nf">lowercaseString</span><span class="p">]);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"upper case string: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">originalString</span> <span class="nf">uppercaseString</span><span class="p">]);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"after  Method Swizzle---------"</span><span class="p">);</span>
<span class="p">[</span><span class="n">Swizzle</span> <span class="nf">swizzleClass</span><span class="p">:[</span><span class="n">originalString</span> <span class="nf">class</span><span class="p">]</span>
	     <span class="nf">fromSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">lowercaseString</span><span class="p">)</span>
	       <span class="n">toSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">uppercaseString</span><span class="p">)];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"lower case String: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">originalString</span> <span class="nf">lowercaseString</span><span class="p">]);</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"upper case string: %@"</span><span class="p">,</span> <span class="p">[</span><span class="n">originalString</span> <span class="nf">uppercaseString</span><span class="p">]);</span>

<span class="c1">//输出：
//original string  : hello,WORLD!
//before Method Swizzle---------
//lower case String: hello,world!
//upper case string: HELLO,WORLD!
//after  Method Swizzle---------
//lower case String: HELLO,WORLD!
//upper case string: hello,world!
</span><span class="o">//</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>可以看到在Method Swizzle后，同样是<code class="highlighter-rouge">lowercaseString</code>和<code class="highlighter-rouge">uppercaseString</code>的结果交换了，有没有一个感觉自己是个黑客了呢。</p>

<h3 id="uiviewcontroller">2.3 应用2: 打印当前UIViewController的名字</h3>
<p>下面这个场景对于应用Method Swizzle来说再合适不过了</p>

<blockquote>
  <p>Method Swizzle 应用场景: 给你一个Xcode project修改代码。在修改前你想要了解出现在手机上的当前UIView对应得UIViewController到底是什么类, 比如在<code class="highlighter-rouge">ViewDidAppear</code>加入<code class="highlighter-rouge">NSLog(@"%@: [self class]")</code>让其自行打印。由于custmozied的各种视图控制器继承自如UITableViewController, UITabViewController, UINavigationViewController,而它们都继承自UIViewController。因此最笨的方法是你需要重写customized每一个视图控制器中的<code class="highlighter-rouge">ViewDidAppear</code>，聪明一点就是重写其父类(那也有好多个)。再聪明一点是重写UIViewController。问题是UIViewController我们没有其源码！这个时候我们就可以用Method Swizzle.</p>
</blockquote>

<p>代码如下。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></td><td class="code"><pre><span class="n">UIViewController</span> <span class="o">+</span> <span class="n">Swizzle</span><span class="p">.</span><span class="n">h</span>

<span class="cp"># import &lt;UIKit/UIKit.h&gt;
# import "Swizzle.h"
</span>
<span class="k">@interface</span> <span class="nc">UIViewController</span> <span class="p">(</span><span class="nl">Swizzle</span><span class="p">)</span>
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">swizzle_viewDidAppear</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>
<span class="k">@end</span>


<span class="n">UIViewController</span> <span class="o">+</span> <span class="n">Swizzle</span><span class="p">.</span><span class="n">m</span>

<span class="k">@implementation</span> <span class="nc">UIViewController</span> <span class="p">(</span><span class="nl">Swizzle</span><span class="p">)</span>

<span class="k">+</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">load</span><span class="p">{</span>
	<span class="p">[</span><span class="n">Swizzle</span> <span class="nf">swizzleClass</span><span class="p">:[</span><span class="n">self</span> <span class="nf">class</span><span class="p">]</span> <span class="nf">fromSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">viewDidAppear</span><span class="o">:</span><span class="p">)</span> <span class="n">toSelector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">swizzle_viewDidAppear</span><span class="o">:</span><span class="p">)];</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">swizzle_viewDidAppear</span><span class="o">:</span><span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="n">animated</span><span class="p">{</span>
	<span class="p">[</span><span class="n">self</span> <span class="nf">swizzle_viewDidAppear</span><span class="p">:</span><span class="n">animated</span><span class="p">];</span>
	<span class="n">NSLog</span><span class="p">(</span><span class="s">@"the current appeared ViewController: %@"</span><span class="p">,[</span><span class="n">self</span> <span class="nf">class</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">@end</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>我们在声明了一个<code class="highlighter-rouge">-(void)swizzle_viewDidAppear:(BOOL)animated;</code>方法，在它的实现里调用了<code class="highlighter-rouge">[self swizzle_viewDidAppear:animated]</code>，然后加入一句打印自身类的语句。在<code class="highlighter-rouge">+(void)load</code>里我们Method Swizlle两者的实现。
首先category的<code class="highlighter-rouge">+(void)load</code>保证其在尽可能很早的时候已经执行Method Swizzle（<code class="highlighter-rouge">+(id)initialize</code>不行，因为其只会在第一次调用方法时才执行，因此有可能太迟，有可能永不执行。）然后当你的各个视图控制器的<code class="highlighter-rouge">-(void)viewDidAppear:(BOOL)animated</code>执行时，其IMP是line20-21。而line20调用<code class="highlighter-rouge">[self swizzle_viewDidAppear:animated]</code>时，其IMP又是UIViewController<code class="highlighter-rouge">-(void)viewDidAppear:(BOOL)animated</code>的IMP。不会有循环。</p>

<p>当你在各种视图控制器中切换时，他们的类就自行打印出来了，Cool！</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="c1">//输出：
//the current appeared ViewController: UITabBarController
//the current appeared ViewController: UINavigationController
//the current appeared ViewController: PBBibleBookViewController
//the current appeared ViewController: UIInputWindowController
//the current appeared ViewController: PBBibleVolumeViewController
//the current appeared ViewController: PBBibleChapterViewController
</span><span class="o">//</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="section">2.4 注意点</h3>

<p>在用Method Swizzling的时候，有一些坑需要注意：
1. 要尽可能早的执行swizzle，因此在<code class="highlighter-rouge">+(void)load</code>而不是在<code class="highlighter-rouge">+(id)initialize</code>里;
2. 用GCD的d<code class="highlighter-rouge">ispatch_once</code>保证其线程安全且执行一次;
3. 要注意方法命名冲突，用swizzle_前缀比较合适，表示Method Swizzle的方法。</p>

<h2 id="section-1">3 总结</h2>
<p>Method Swizzle在sending message的过程中寻找IMP这一步动态注入代码，这使得当你没有源码时依然可以重写其方法。这比子类化重写和category重写要有更多优势。比如你没有实例化控制权，子类化重写则无济于事; category重写会覆盖掉原方法，而通常我们需要的是扩展功能同时保留原有功能。Method Swizzle提供了另一种优雅的解决方案，其中的细节需要读者细细品味。</p>


            <div class="clearfix"></div>
        </div>


    
    <ul class="tag_box list-unstyled list-inline">
      <li><i class="fa fa-folder-open"></i></li>
      
      
      
        <li><a href="http://www.shunmian.me/categories.html#Objective-C-ref">
          Objective-C <span>(10)</span>
          
        </a></li>
      
      
    </ul>
    

    
    <ul class="list-inline">
      <li><i class="fa fa-tags"></i></li>
      
      
      
        <li>
          <a href="http://www.shunmian.me/tags.html#Method-ref">
          Method <span>(1)</span>
          
          </a>
        </li>
      
      
      
    </ul>
    

<hr />
<div >
    <section class="col-sm-7">
        <h4>Share Post</h4>
        <a class="btn btn-default btn-sm" href="http://twitter.com/share?text=OC Runtime(三)： Method Swizziling&via=Wanderl29817400" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fa fa-twitter fa-sm"></i>
        Twitter
        </a>

        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-sm"></i>
          Facebook
        </a>

        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-sm"></i>
          Google+
        </a>
    </section>

    <section class="col-sm-5">
        <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df" class="img-rounded" />
        <h4>Shunmian</h4>
        <p class="author-bio">节物风光不相待，桑田碧海须臾改，唯有美食和code不可辜负。</p>

    </section>

</div>
<div class="clearfix"></div>

<ul class="pager">
    
    <li class="previous"><a href="http://www.shunmian.me/objective-c/2016/03/15/OC-Runtime(%E4%BA%8C)_Associated-Objects.html" title= "">&larr; Previous</a></li>
    
    
    <li class="next">"<a href="http://www.shunmian.me/objective-c/2016/03/17/OC-Runtime(%E5%9B%9B)_isa-swizzling.html" title= "OC Runtime(四)： isa Swizziling">Next &rarr;</a></li>
    
</ul>

    <hr />
    
    <section class="comments" style="margin-top:15px;">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shunmianjohnson'; // required: replace example with your forum shortname
        if(disqus_shortname){
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        }
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    </div>
    <div class="col-sm-1sidebar-2"></div>
    <div class="clearfix"></div>
</article>
<div class="clearfix"></div>


                <div class="footer">
                    <footer>
                        <hr />
                        <p> &copy: 2015 Shunmian with jekyll. Theme: <a href="https://github.com/dbtek/dbyll"dbyll</a> by dbtek.
                        </p>
                    </footer>
                </div>
            </div>
        </div>
    </div>


    <script src="/assets/js/jquery-2.2.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/script.js"></script>
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

    <script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
    <script type="text/javascript">

$youziku.load(".sidebar_bio", "bdcc72b8235345649b02c123dac5610b", "SiYuan-ExtraLight");


   $youziku.draw();
</script>

</body>

</html>

