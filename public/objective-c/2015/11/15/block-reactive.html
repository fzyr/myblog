<!DOCTYPE html>
<html lang = "en">
<head>
    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/posts/favico/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/posts/favico/favico/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/posts/favico/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/posts/favico/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/posts/favico/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/posts/favico/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/posts/favico/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/posts/favico/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/posts/favico/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/images/posts/favico/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/posts/favico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/images/posts/favico/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/posts/favico/favicon-16x16.png">
    <link rel="manifest" href="/assets/images/posts/favico/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/assets/images/posts/favico/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">   

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/font-awesome/css/font-awesome.min.css">
    <link href="/assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/syntax.css">


    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600' rel='stylesheet' type='text/css'>
<!--     <script type="text/javascript" src="http://api.youziku.com/webfont/FastJS/yzk_976E121ED7CC0870"></script> -->

    <title>SHUNMIAN</title>
</head>


<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 sidebar hidden-xs sidebar">
                
<!--sidebar.html-->
        <header class="sidebar_header " role="banner">
            <a href="http://www.shunmian.me/index.html">
                <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df?s=150" class="img-circle img-responsive center-block sidebar_logo sidebar_img" />
            </a>


            <h3 class="title text-center">
                <a href="http://www.shunmian.me/index.html">SHUNMIAN</a>
            </h3>

        </header>


        <hr class="hr_short"/>
        <div id = "bio" class="text-center sidebar_bio">
            

                <p>嗨，欢迎来到我的博客。<br/>
                我是Shunmian，一名iOS开发者。<br/>
                <hr class = "hr_short_low">
                正在学习Algorithm，Functional Programming，Machine Learning，Data Mining 和 Cloud Computation。 

                </p>

            
        </div>


        <hr class="hr_middle"/>
        <div id = "contact-list" class="text-center">
            <ul class="list-unstyled list-inline">
                <li>
                    
                    <a class="btn btn_info_outline" href="mailto:shunmian@gmail.com"><i class="fa fa-envelope fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-github fa-lg"></i></a>
                    
                </li>

                <li>
                    
                    <a class="btn btn_info_outline" href="https://github.com/shunmian"><i class="fa fa-twitter fa-lg"></i></a>
                    
                </li>

                <li>
                    <a class="btn btn_info_outline" href="http://www.shunmian.me/feed.xml"><i class="fa fa-rss fa-lg"></i></a>
                </li>
        </div>


        <hr class="hr_short"/>
        <div id = "contact-list" class="text-center">
            <ul class="unstyled-list list-inline">
                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/index.html"><i class="fa fa-home fa-md"></i> 主页</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/tags.html"><i class="fa fa-tags fa-md"></i> 标签</a>
                </li>

                <li>
                    <a class="btn btn_info_outline btn-sm" href="http://www.shunmian.me/categories.html"><i class="fa fa-list fa-md"></i> 分类</a>
                </li>
            </ul>
        </div>
        <div class="padding_bottom_500"></div>




<!--sidebar.html end-->

            </div>

            <div class="col-sm-9 col-sm-offset-3">
                

<div class="page-header col-sm-10 col-sm-offset-1">
    <h1 class="article_mainTitle">Block 和 ReactiveCocoa的理解（一） </h1>
    <span class="post_date">
        2015-11-15 •
    </span>
    <span class="post_category">
        Objective-C
    </span>
</div>

<article class="article">
    <div class="col-sm-10 col-sm-offset-1">
        <div class="article_mainBody">
            <h2 id="blockcallback">1. block的最大用处：回调(callback)</h2>

<p>虽然接触iOS已经8个月了，block 作为Objective C中对于回调(callback)的实现，理解起来还是有点模棱两可。在《Pro Multithreading and Memory Management for iOS and OS X》书中，Kazuki Sakamoto 对block的定义是：</p>

<blockquote>
  <p>拥有自动变量（可以在block声明的语义环境里捕捉变量的状态）的匿名（使函数体(code)成为和数据(data)一样的一等公民，作为函数调用时输入的实参（argument））函数。</p>
</blockquote>

<p>我发现，在大部分应用block的场景，这样的定义不够sharp，使人模棱两可。我用我自己的理解重定义block：
&gt;拥有自动变量（可以在block声明的语义环境里捕捉变量的状态）的匿名(使函数体(code)成为和数据(data)一样的一等公民，作为函数调用时输入的实参（argument））<strong>回调</strong>（callback,等待被调用）函数。 </p>

<p>回调(callback)两个字把block在大部分场景应用时的扮演的角色给准确描述。下面我举一个简单的例子来解释回调。NSArray的实例方法 *- enumerateObjectsUsingBlock:(void (^ )(id obj, NSInteger idx, BOOL *stop))block 是一个用block实现数组枚举的方法。下面是该方法的简单应用：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>NSArray *cities = @[@"Beijing", @"Shanghai", @"Guangzhou", @"Shenzhen"，@"Hong Kong"];     [cities enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL * stop) {         NSLog(@"index: %lu, obj: %@, stop: %d",(unsigned long)idx,obj,*stop);         if(idx == 3){             *stop = YES;         }     }];

//这是一个再简单不过的数组枚举。输出为：

2016-01-06 22:52:18.143 Chapter00_Block implmenetaion[18596:780185] index: 0, obj: Beijing, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 1, obj: Shanghai, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 2, obj: Guangzhou, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 3, obj: Shenzhen, stop: 0
</code></pre>
</div>

<p>那么，如何理解上面block的新定义里的回调呢。由于apple 自己里大部分类的实现是保密的，我们来自己定义一个方法来简单实现下这个- enumerateObjectsUsingBlock：方法的功能。首先来给NSArray添加一个名为Enumeration的category，加入以下代码。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">NSArray</span><span class="o">+</span><span class="n">Enumeration</span><span class="p">.</span><span class="n">h</span>

<span class="cp">#import &lt;Foundation/Foundation.h&gt;
</span><span class="k">@interface</span> <span class="nc">NSArray</span> <span class="p">(</span><span class="nl">Enumeration</span><span class="p">)</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">customizedEnumerateWithBlock</span><span class="p">:(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">id</span> <span class="n">obj</span><span class="p">,</span> <span class="n">NSInteger</span> <span class="n">index</span><span class="p">,</span> <span class="n">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">))</span><span class="nv">block</span><span class="p">;</span>
<span class="k">@end</span>

<span class="n">NSArray</span><span class="o">+</span><span class="n">Enumeration</span><span class="p">.</span><span class="n">m</span>

<span class="cp">#import "NSArray+Enumeration.h"
</span><span class="k">@implementation</span> <span class="nc">NSArray</span> <span class="p">(</span><span class="nl">Enumeration</span><span class="p">)</span>
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">customizedEnumerateWithBlock</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="n">id</span><span class="p">,</span> <span class="n">NSInteger</span><span class="p">,</span> <span class="n">BOOL</span> <span class="o">*</span><span class="p">))</span><span class="nv">block</span><span class="p">{</span>
    <span class="n">BOOL</span> <span class="n">stop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="n">block</span><span class="p">(</span><span class="n">i</span><span class="p">,[</span><span class="n">self</span> <span class="nf">objectAtIndex</span><span class="p">:</span><span class="n">i</span><span class="p">],</span><span class="o">&amp;</span><span class="n">stop</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
 <span class="p">}</span>  
<span class="k">@end</span>
</code></pre>
</div>

<p>如果你把cities的数组枚举方法换成这个，那么输出是一样的。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>NSArray *cities = @[@"Beijing", @"Shanghai", @"Guangzhou", @"Shenzhen", @"Hong Kong"];     [cities customizedEnumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL * stop) {         NSLog(@"index: %lu, obj: %@, stop: %d",(unsigned long)idx,obj,*stop);         if(idx == 3){             *stop = YES;         }     }];

//输出为：

2016-01-06 22:52:18.143 Chapter00_Block implmenetaion[18596:780185] index: 0, obj: Beijing, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 1, obj: Shanghai, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 2, obj: Guangzhou, stop: 0
2016-01-06 22:52:18.144 Chapter00_Block implmenetaion[18596:780185] index: 3, obj: Shenzhen, stop: 0
</code></pre>
</div>

<p>由此可见，我们自己实现的数组枚举能实现原本的数组枚举方法。在- customizedEnumerateWithBlock: 的实现里，回调了block这个函数。因此若有方法里有block体作为参数，则意味著这个方法在调用其他函数的同时，这个block在等待将来被调用。那么该block什么时候被调用呢（这里是for 循环语句里），在实际应用block场景里，block的调用更多地是简化网络请求，delegate等。</p>

<p><strong>因此“回调”是block我个人认为最大的用处。</strong></p>

<h2 id="reactivecocoasubscription">2. ReactiveCocoa的subscription原理</h2>

<p>作为响应式函数编程的iOS实现，ReactiveCocoa将iOS编程带入了一个新纪元，其最大的贡献在于：
&gt;统一消息传递机制：iOS 开发中有着各种消息传递机制，包括 KVO、Notification、delegation、block 以及 target-action 方式。</p>

<p>ReactiveCocoa的入门可以参考
 http://www.raywenderlich.com/62699/reactivecocoa-tutorial-pt1
http://www.raywenderlich.com/62796/reactivecocoa-tutorial-pt2</p>

<p>这里我着重要说的是ReactiveCocoa （订阅）subscription的实现原理–block回调的应用。在ReactiveCocoa里，RACSignal， RACSubscriber, RACDisposal 是最核心的三个类。下面我们就一个简单的例子深入理解subscription的实现原理，见下面代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-(RACSignal *)signInSignal {
  // part 1:[RACSignal createSignal]来获得signal
  return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
           [self.signInService signInWithUsername:self.usernameTextField.text
                                         password:self.passwordTextField.text
                                         complete:^(BOOL success) {
  // part 3: 进入didSubscribe，通过[subscriber sendNext:]来执行next block
             [subscriber sendNext:@(success)];
             [subscriber sendCompleted];
            }];
            return nil;
          }];
}

// part 2 : [signal subscribeNext:]来获得subscriber，然后进行subscription
[[self signInSignal] subscribeNext:^(id x) {
    NSLog(@"Sign in result: %@", x);
}];
</code></pre>
</div>

            <div class="clearfix"></div>
        </div>


    
    <ul class="tag_box list-unstyled list-inline">
      <li><i class="fa fa-folder-open"></i></li>
      
      
      
        <li><a href="http://www.shunmian.me/categories.html#Objective-C-ref">
          Objective-C <span>(10)</span>
          
        </a></li>
      
      
    </ul>
    

    
    <ul class="list-inline">
      <li><i class="fa fa-tags"></i></li>
      
      
      
        <li>
          <a href="http://www.shunmian.me/tags.html#Block-ref">
          Block <span>(1)</span>
          ,
          </a>
        </li>
      
        <li>
          <a href="http://www.shunmian.me/tags.html#ReactiveCocoa-ref">
          ReactiveCocoa <span>(1)</span>
          
          </a>
        </li>
      
      
      
    </ul>
    

<hr />
<div >
    <section class="col-sm-7">
        <h4>Share Post</h4>
        <a class="btn btn-default btn-sm" href="http://twitter.com/share?text=Block 和 ReactiveCocoa的理解（一）&via=Wanderl29817400" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fa fa-twitter fa-sm"></i>
        Twitter
        </a>

        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-sm"></i>
          Facebook
        </a>

        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-sm"></i>
          Google+
        </a>
    </section>

    <section class="col-sm-5">
        <img src = "https://www.gravatar.com/avatar/02eefecba7f0b21939d12a37f94bf5df" class="img-rounded" />
        <h4>Shunmian</h4>
        <p class="author-bio">节物风光不相待，桑田碧海须臾改，唯有美食和code不可辜负。</p>

    </section>

</div>
<div class="clearfix"></div>

<ul class="pager">
    
    <li class="previous"><a href="http://www.shunmian.me/category%20theory/2015/10/08/Category-Theory-1.1-Category-the-essence-of-composition.html" title= "">&larr; Previous</a></li>
    
    
    <li class="next">"<a href="http://www.shunmian.me/objective-c/2016/02/18/Key-Value-Observing.html" title= "Key Value Observing">Next &rarr;</a></li>
    
</ul>

    <hr />
    
    <section class="comments" style="margin-top:15px;">
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shunmianjohnson'; // required: replace example with your forum shortname
        if(disqus_shortname){
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        }
      </script>
      <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    </div>
    <div class="col-sm-1sidebar-2"></div>
    <div class="clearfix"></div>
</article>
<div class="clearfix"></div>


                <div class="footer">
                    <footer>
                        <hr />
                        <p> &copy: 2015 Shunmian with jekyll. Theme: <a href="https://github.com/dbtek/dbyll"dbyll</a> by dbtek.
                        </p>
                    </footer>
                </div>
            </div>
        </div>
    </div>


    <script src="/assets/js/jquery-2.2.0.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/script.js"></script>
    <script type="text/javascript">

$youziku.load(".sidebar_bio", "bdcc72b8235345649b02c123dac5610b", "SiYuan-ExtraLight");


   $youziku.draw();
</script>

</body>

</html>

