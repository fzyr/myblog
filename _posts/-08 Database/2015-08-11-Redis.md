---
layout: post
title: Redis
categories: [-08 Database]
tags: [Database,Redis]
number: [-6.1.1]
fullview: false
shortinfo: Redis

---
目录
{:.article_content_title}


* TOC
{:toc}

---
{:.hr-short-left}

## 1 redis介绍 ##

### 1.0 概况

为什么redis快：
- 内存存储
- 单线程
- 多路IO复用

### 1.1 Quick start

#### 1.1.1 Install

#### 1.1.2 `redis-server`

- start `redis-server` with config file. Default `redis.conf` is in `/usr/local/etc/redis.conf`, if type `redis-server`, it will use that default config to start redis server; if you want to start with your config, please copy the default `redis.conf` and modify it, then `redis-server` `path-to-your-version-of-redis-config`.

- start `redis-server` in daemon mode. Change daemonize `no` to `yes` in your redis config, then start `redis-server`.

#### 1.1.3 `redis-cli`

- start `redis-cli`: type `redis-cli`;
- test `redis-cli`'s connection to `redis-server`: type `ping`, you should expect to receive `pong`;
- shutdown server: type `shutdown`;

### 1.2. Basic Topics

#### 1.2.1 Data Type & Operation

- 默认情况下，有16个数据库， 用 `select <dbid>` 来选择
- redis是单线程加多路IO复用。

- value的操作，5种数据类型：
  - `string`: 最多一个string value 512MB. `string`类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。
    - `set <key> <value>`;
    - `append <key> <value>`: concat value, 返回concat后结果的string长度。
    - `strlen <key>`: 获取value的长度;
    - `setnx <key> <value>`: 只有在`key`不存在时才设定`value`,若存在，什么也不做。
    - `incr <key>`: 增1，只有`key`对应的`value`是`string`同时是数字时， 即`get <key>`返回"5"(not "v5"); `incrby <ker> <value>`, 同`incr <key>`，except步长为`<value>`;
    - `decr <key>`:  同`incr <key>`，except减1; `decrby <ker> <value>`, 同`decr <key>`，except步长为`<value>`;
    - `mset <key> <value1> <key2> <value2> ...`, 同时设定多个key-value对, 原子性；
    - `mget <key> <value1> <key2> <value2> ...`, 同时获取多个key-value对, 原子性；
    - `msetnx <key> <value1> <key2> <value2> ...`, 同时设定(若值不为0)多个key-value对, 原子性；
    - `getrange <key> <idx1> <idx2>`, 获取`<key>`的`<value>`, 然后substr; `getrange <key> <idx1> -1`, -1表示最后一个。
    - `setrange <key> <startIndex> <value>`, 设定`<key>`的值为`<value>`, 从`<startIndex>`开始。
    - `setex <key> <value> <expire>`, 设定值的同时设定ttl。
    - `getex <key>`, 获取值的同时设定ttl。
    - `getset <key> <newValue>`, 设置新值，同时返回就值。
  - `list`: doubly linked list 
    - `lpush/rpush <key> <value1> <value2>`: 从左边/右边插入一个或多个值。
    - `lpop/rpop <key>`: 从左边/右边吐出一个或多个值。
    - `rpoplpush <key1> <key2>`: 从`<key1>`列表右边吐出一个值，插到`<key2>`列表左边。值在键在，值亡人亡。
    - `lrange <key> <start> <pop>`: 按照索引下标获得元素, 从左往右。
    - `lindex <key> <indxe>`: 按照索引下标获得元素, 从左往右。
    - `llen <key>`: 获得列表长度, 从左往右。
    - `llen <key>`: 获得列表长度, 从左往右。
    - `linsert <key> before <value> <newValue>`: 在`<value>`的后面插入`<newValue>`。 
    - `lrm <key> <n> <value>`: 从左边删除n个`<value>`。
  - `set`: 自动排重，实现为hash表，insert, delete 都是0(1).
    - `sadd <key> <value1> <value2>`， 增加；
    - `smembers <key>`, 获取；`smemebrs <key> <value>`， 返回1表示有值value;
    - `scard <key>, 返回长度个数`;
    - `srem <key> <value>`删除value;
    - `spop <key>`,随机吐出一个值；
    - `srandommember <key> <number>`, 随机取出number个值，但不会从set中删除；
    - `sinter <key1> <key2>`, 两个set的交集；
    - `sunion <key1> <key2>`, 两个set的并集；
    - `sdiff <key1> <key2>`, 两个set的差集；
  - `hash`, 类似java里的`Map<String, Object>`, 用于存储对象。
    - `hset <key> <field> <value> ...`;
    - `hget <key> <field>`;
    - `hmset <key> <field1> <value1> <field2> <value2>`, 批量设置field value;
    - `hexists <key> <field>`;
    - `hkeys <key>`;
    - `hvals <key>`;
    - `hincrby <key> <field1> <increment>`;
    - `hsetnx <key> <field> <value>`;
  - `zset`: 和`set`类似，不同之处是有有序的，依据score。
    - `zadd <key> <score1> <value1> <score2> <value2>`, 将一个或多个member元素及其score值加入到有序集key当中;
    - `zrange <key> <start> <top> [WITHSCORES]`, 返回start和stop之间的元素，若WITHSOCRES, 则同时返回分数;
    - `zincrby <key> <field> <increment>`, 增加key.field的score by increment;
    - `zrangebyscore <key> <min> <max> [WITHSCORES] [limit offset count]`, 返回min和max之间的元素，若WITHSOCRES, 则同时返回分数, 从小到大
    - `zrevrangebyscore <key> <min> <max> [WITHSCORES] [limit offset count]`, 和`zrangebyscore`一样，但是从大到小

- key的操作
  - `keys *`;
  - `exists <key>`;
  - `type <key>`;
  - `del <key>`;
  - `expire <key> <seconds>`, 为某个键值设置过期时间;
  - `ttl <key>`; 正数表示还有多久过期， -1表示永不过期， -2表示已过期。
  - `dbsize`: 当前数据库有多少个key(名字有点confuse，为什么不称为"keySize"). Redis 可以存储2^32个key，因此存储瓶颈不在于key的最大允许数量，而在于机器的内存大小。
  - `flushdb`: 清空当前数据库;
  - `flushall`: 清空所有数据库(共16个)。


### 1.3 Advanced Topics

#### 1.3.1 Config File (`redis.conf`)

- `daemonize`: yes/no, 是否在后台运行;
- `loglevel notice`: 日志级别;
- `database 16`: 默认有16个数据库;
- `maxclients 10000`; 最大客户连接数;
- `volatile-lru`: evict using approximated LRU among the keys with an expire set;
- lua script.

#### 1.3.2 Transaction

- Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化，按顺序今夕。事务在执行过程中，不会被**其他客户端**发送来的命令请求所打断。Redis事务的主要总用就是**串联多个命令**(即多个命令成为1个atomic命令，中间插入不了其他客户端的命令)防止别的命令插队。但是若组队过程中`Multi` + [`cmd1`, `cmd2`, `cmd3`]语法正确, 但是执行过程中`Exec`的`cmd3`出错，则`cmd1`和`cmd2`依旧会执行，不会回滚，这和传统意义的atomic事务不一样
- `Multi`
- `Exec`
- `Discard`

{: .img_middle_lg}
![regular expression]({{site.url}}/assets/images/posts/-08 Database/Redis/transaction.png)

##### 1.3.1 悲观锁 & 乐观锁


>悲观锁： 总是加锁，悲观的认为它的操作中间都有可能被其他client改变。悲观锁包括MySQL的行级锁，表级锁。

>乐观锁： 总是不加锁，乐观的认为它的操作中间都不可能被其他client改变。乐观锁通过加版本来比较事务前后的数据一致性，若不一致则撤销事务。


{: .img_middle_hg}
![regular expression]({{site.url}}/assets/images/posts/-08 Database/Redis/transaction & lock.png)


##### 1.3.2 `watch` & `unwatch`

{% highlight bash linenos %}

// client 1               // client 2
SET k1 1         
MULTI
INCR k1
INCR k1
                          <- INCR k1 
EXEC            
// k1 = 3     /           / k1 = 4
{% endhighlight %}

{% highlight bash linenos %}

// client 1               // client 2
SET k1 1         
WATCH
MULTI
INCR k1
INCR k1
                          <- INCR k1
EXEC            
// k1 = 2                 // k1 = 2
// exec return nil, it is notified k1 is changed to a different value after WATCH
{% endhighlight %}



##### 1.3.2.1 Example 秒杀


## 2 Examples

### 2.1 Redis client `Jedis`.

## 2 总结

{: .img_middle_lg}
![regular expression]({{site.url}}/assets/images/posts/2015-06-01/MySQL overview.png)

{% highlight mysql linenos %}

{% endhighlight %}




## 3 参考资料 ##
- [《MongoDB》](https://www.mongodb.com/cn);






