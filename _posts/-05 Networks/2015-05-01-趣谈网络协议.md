---
layout: post
title: 趣谈网络协议
categories: [-05 Networks]
tags: [Networks,Wireshark]
number: [-8.2]
fullview: false
shortinfo: 本文是《趣谈网络协议》的总结。

---
目录
{:.article_content_title}


* TOC
{:toc}

---
{:.hr-short-left}

## 1 介绍 ##

## 1 Application Layer


### 1.0 Socket


{: .img_middle_hg}
![broadcast domain](/assets/images/posts/-05 Network/2015-05-01-趣谈网络协议/Socket_data_structure.png)

### 1.1 `ping` program

The name "ping" is taken from the sonar operation to locate objects. The Ping program is used to test whether another host is reachable. The program sends an ICMP echo request message to a host, expecting an ICMP echo reply to be returned. 

1. Normally if you can't Ping a host, you won't be able to Telnet or FTP to that host. Conversely, if you can't Telnet to a host, ping is often the starting point to determine what the problem is. 

2. Ping also measures the round-trip time to the host, giving us some indication of how "far away" that host is. 

3. Ping is a diagnostic tool and can be used to further explore ICMP. 

4. Ping also examine the IP record route and timestamp options.

5. Nowadays, Ping may shoa a host as being unreachable, yet we might be able to Telnet to poart 25(the mall server).


## 2 Transport Layer

TCP是成熟的社会人，UDP是头脑简单的小朋友。TCP复杂，UDP简单；TCP维护链接，UDP谁都相信；TCP会坚持知进退；UDP愣头青一个，勇往直前。但是，UDP协议看起来简单，恰恰提供了巨大的扩展空间。


### 2.1 TCP

TCP， 因性恶而复杂，先恶后善反轻松

- TCP提供可靠交付，通过TCP传输的数据，无差错，不丢失，不重复，并且按序到达。
- TCP可以有拥塞控制。它意识到包丢了或者网络环境不好，就会根据情况调整自己的行为，看看是不是发快了，要不要发慢点。UPD就不会，应用让我发，我就发，管它洪水滔天。

{: .img_middle_hg}
![broadcast domain](/assets/images/posts/-05 Network/2015-05-01-趣谈网络协议/TCP状态机.png)

流量控制:

拥塞堵塞:




#### 2.1.0 TCP Introduction
TCP Segment: TCP 报文段

Socket: combination of an IP address and a port number
Socket Pair (a unique TCP connection): 4-tuple consisting of the client IP address and port, server IP address and port.

Sequence Number: Byte ID

Flags:
- SYNC: hand shake. A SYNC consume one sequence number, for example 1230, means this packet's sequence number is 1230.
- FIN: sender is finish sending data, for hand wave
- ACK: acknowledgements number (the sender has successfully sent up through but not including that byte) is valid
- URG: the urgent pointer is valid
- PSH: the receiver should pass this data to application as soon as possible
- RST: Reset the connection

TCP Connection is full-duplex, each direction is independent of the other.

Option: the most common option field is maximum segement size option, called MSS. It is normally included on the first segment exchanged.

TCP can be described as a sliding window protocal without selective or negative acknoledgement. If 1-1024 are received, 2049-3072 are received then, all receiver can ack is 1025; If 1-1024 are received, 2049-3072 are received then with incorrect checksum, all receiver can ack is 1025. 

TCP flow control:
- sender: Congestion Avoidance, the flow control imposed by the sender, based on the sender's perceived network congestion. 
- receiver: Window Size Advertisements, flow control imposed by the receiver, based on the amount of available buffer space at the receiver for this connection.
- Both ends can be both sender and receiver.

#### 2.1.1 TCP Connection Establishment and Termination



3 way hand-shade
- active open
- passive open
- ISN (initial sequence number)

4 way hand-wave
- half close
- active close
- passive close

> Q: 为什么握手是3次而挥手是4次？因为链接和挥手的过程不一样！握手时其实也可以4次(将第2次拆分为两步)，A-(SYNC)->B, B-(ACK)->A, B-(SYNC)->A, A-(ACK)->B； 就像挥手时A-(FIN)->B, B-(ACK)->A, B-(FIN)->A, A-(ACK)->B一样4次。但是连接时可以合并为A-(SYNC)->B, B-(ACK，SYNC)->A, A-(ACK)->B 3次；挥手时不能合并，因为 B-(ACK)->A和B-(FIN)->A之间，B可能还有数据要发送给A,等所有发送完才B-(FIN)->A。整个过程其实是**双向**链接的建立和关闭过程。The recepit of FIN only means there will be not more data flowing in that direciton. A TCP can still send data fater receiving a FIN.



#### 2.1.2 TCP Interactive Data Flow


#### 2.1.3 TCP Bulk Data Flow

Window Size Advertisements: flow control imposed by the receiver, based on the amount of available buffer space at the receiver for this connection.

Sliding Window

Slow Start

#### 2.1.4 TCP Timeout and Retransmission

RTO

Congestion: detected by RTO timeout or receipt of duplicate ACKs.

Congestion Avoidance: flow control imposed by the sender, based on the sender's perceived network congestion.

Fast Retransmit

Fast Recovery

Repacketization.

#### 2.1.5 TCP Persist Timer

#### 2.1.6 TCP Keepalive Timer

#### 2.1.7 TCP Futures and Performance


### 2.2 UDP


UDP, 因性善而简单，难免碰到"城会玩"。

UDP之上的扩展。

- 网页或者APP访问。QUIC(QUICK UDP Internet COnnecitons), google提出的一种基于UDP改进的通信协议，目的是降低网络通信的延迟，提供更好的用户交互体验。QUIC在应用层上，会自己实现快速链接的建立，减少重传时延，自适应拥塞控制。

- 流媒体的协议额。当前流媒体**直播**多使用基于TCP的RTMP协议。TCP的时序特性要保证前一个收到了，下一个才能确认，如果前一个收不到，下一个就算包道林，在缓存里面，也需要等着。而直播显然不能这样，宁可丢包，也不要卡顿。因而很多直播应用，都基于UDP实现了自己的视频传输协议。

- 实时游戏。要求长连接(TCP)保证实时传输; 但是一台机器能够支持的TCP链接数目是有限的(内核需要维护TCP链接的一些数据结构)，因此在异步IO机制引入之前，UDP常常是应对海量客户端连接的策略。所以一些游戏厂商自己实现可靠的UDP协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

- IoT物联网。维护TCP协议资源要求多，而IoT很可能是个内存非常小的嵌入式系统；同时IoT对实时性要求也很高。Google旗下的Nest建立了Thread Group, 推出了物联网通信协议Thread,就是基于UDP协议的。

- 移动通信领域。在4G网络里，移动流量上网的数据面对的协议GTP-U是基于UDP的。因为移动网络协议比较复杂，而GTP协议本身就包含复杂的手机上线下线的通信协议。如果基于TCP, TCP的机制就显得非常多余。

### 2.3 ICMP (Internet Control Messages Protocol 网间控制报文协议)

如果收到一份UDP数据而目的端口与某个正在使用的进程不相符，那么UDP返回一个ICMP不可达报文。可以用TFTP来强制生成一个端口不可达报文。

### 2.4 IGMP

## 3 Netwokr Layer

### 3.1 IP

- IP vs Mac

IP是地址，有定位功能，定义了整个网络端到端的传输行为；MAC是身份证，无全局定位功能，有局部定位功能，定义了本地局域网的传输行为。

MAC的唯一性设计是为了组网的时候，不同的网卡放在一个网络里面的时候，可以不同担心冲突。从硬件角度，保证不同的网卡有不同的标识。MAC地址有一定的定位功能，只不过范围非常有限。你可以根据IP地址，找到杭州市网商路599号B楼6层，但是依然找不到我，你就可以靠吼了，大声喊身份证XXX是哪位？我听到了，就会站起来说，是我啊。但是如果你在上海，到处喊身份证XXX是哪位，我不在现场，当然不会回答，因为我在杭州不在上海。

所以MAC地址的通信范围比较小，局限在一个子网里面。例如从192.168.0.2/24访问192.168.0.3/24是可以用MAC地址的。一旦跨子网，即从192.168.0.2/24到192.168.1.2/24,MAC地址就不行了，需要IP地址起作用了。

- 公有IP地址 vs 私有IP地址

{: .img_middle_hg}
![broadcast domain](/assets/images/posts/-05 Network/2015-05-01-趣谈网络协议/Public_IP_VS_Private_IP.png)



- CIDR(无类型域间选路)可以用来判断是不是本地人。例如10.100.122.2/24表示前24位位网络号，后8位是主机号；子网掩码是255.255.255.0, 将其和IP地址按位计算，就可得到网络号。


{% highlight c linenos %}
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> mtu 16384
	inet 127.0.0.1/8 lo0
	inet6 ::1/128
	inet6 fe80::1/64 scopeid 0x1
en0: flags=8863<UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST> mtu 1500
	ether f4:5c:89:8e:60:91 #Mac地址
	inet6 fe80::1878:382d:f851:a167/64 secured scopeid 0x5 #ipv6
	inet 192.168.0.106/24 brd 192.168.0.255 en0
awdl0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> mtu 1484
	ether c2:ea:eb:74:46:63
	inet6 fe80::c0ea:ebff:fe74:4663/64 scopeid 0x9
utun0: flags=8051<UP,POINTOPOINT,RUNNING,MULTICAST> mtu 2000
	inet6 fe80::23af:77ed:fdc8:8d28/64 scopeid 0xb
{% endhighlight %}

快速查看本机外网IP`curl ifconfig.me`

### 3.1 Routing Table

## 4 Link Layer

### 4.1 MAC

hub集线器只有物理层，采取广播形式，每一个网卡发出地包，每一个链接集线器的网卡(除了源网卡)都会收到。

Switch交换机除了物理层，还有链路层。

link layer解决:

1. 这个包是发给谁的？谁应该接受？通过Mac地址(交换机有MAC地址学习能力，学完了它就知道谁在哪儿了，不用广播了,一台 MAC1 电脑将一个包发送给另一台 MAC2 电脑，当这个包到达交换机的时候，一开始交换机也不知道 MAC2 的电脑在哪个口，所以没办法，它只能将包转发给除了来的那个口之外的其他所有的口。但是，这个时候，交换机会干一件非常聪明的事情，就是交换机会记住，MAC1 是来自一个明确的口。以后有包的目的地址是 MAC1 的，直接发送到这个口就可以了。当交换机作为一个关卡一样，过了一段时间之后，就有了整个网络的一个结构了，这个时候，基本上不用广播了，全部可以准确转发。当然，每个机器的 IP 地址会变，所在的口也会变，因而交换机上的学习的结果，我们称为转发表，是有一个过期时间的。)。
2. 大家都在发，会不会产生混乱？有没有谁先发，谁后发的规则？分多个车道(信道划分),单双号分时限行(轮流协议), 有事儿先出门特堵就回去错过高峰再出来(随机介入协议，以太网就是这种策略)。
3. 发送出错，怎么办?CRC(循环冗余检测)来计算整个包是否在发送的过程中出现了错误。


如何通过IP获取MAC？ARP 协议，也就是已知 IP 地址，求 MAC 地址的协议;

ARP和RAP的请求以广播方式(broadcast)传送，应答以单播方式(unicast)传送

**交换机和VLAN**

当交换机数目越来越多的时候，会遭遇环路问题，让网络包迷路，这就需要使用STP协议，通过华山论剑比武的方式，将有环路的图变成没有环路的树，从而解决环路问题。

交换机数目多会面临隔离问题，可以通过VLAN形成虚拟局域网，从而解决广播问题和安全问题。

#### 4.1.1 网关 vs 路由器

gateway vs router. 路由器是一台设备，它有5个网口或者网卡，相当于有5只手，分别连着5个局域网。每只手的ip地址都和局域网的ip地址相同的网段，每只手都是它握住的那个局域网的网关。任何一个想发往其他局域网的包，都会到达其中一只手，被拿进来，拿下MAC头和IP头，看看，根据自己的路由算法，选择另一只手，加上IP头和MAC头，然后扔出去。


1. 路由类型

路由表

静态路由，从哪个网关进，哪个网关出，都是由一条条规则规定好的。实现原理

- 3项路由: 目标ip, 下一跳ip，出口ip,
- 策略路由: 多路由表/多路径。

动态路由实现原理：
- 距离矢量路由算法: BGP
- 链路状态路由算法: OSPF


2. 网关类型

转发网关(欧洲十国游): 局域网ip不改

NAT(Newtork Address Translate)网关(玄奘西行): 局域网ip改, 即源ip在出网关时会升级到公网ip，目标ip在入网关时会降级到局域网ip。


### 1.2 DHCP与PXE

1. 正确配置IP?

CIDR、子网掩码、广播地址和网关地址

2. DHCP & PXE

{: .img_middle_hg}
![broadcast domain](/assets/images/posts/-05 Network/2015-05-01-趣谈网络协议/DHCP_and_PXE.png)

## 4 查漏补缺

清晰的网络拓扑图：从理论上来讲，应该要清楚地知道一个网络包从原地址到目标地址都需要经过哪些设备，然后逐个ping中间的这些设备或者机器。如果可能，在这个关键点，通过tcpdump -i eth0 icmp, 查看包有没有到达某个点。


hub和switch用来局域网内交流(通过mac地址)，局域网与另一个局域网交流需要网关(gateway,router,通过IP。








## 总结

{: .img_middle_hg}
![broadcast domain](/assets/images/posts/-05 Network/2015-05-01-趣谈网络协议/summary.jpg)


## 4 参考资料 ##

- [《Practical Packet Analysis: Using Wireshark to Solve Real-World Network Problems》](https://www.amazon.com/Practical-Packet-Analysis-Wireshark-Real-World/dp/1593272669/ref=sr_1_1?s=books&ie=UTF8&qid=1477547038&sr=1-1&keywords=practical+packet+analysis);





